<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#1e40af">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>GMAO BAHIA v8.4</title>
<style>
:root{--primary:#1e40af;--primary-light:#3b82f6;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--gray-50:#f8fafc;--gray-100:#f1f5f9;--gray-200:#e2e8f0;--gray-400:#94a3b8;--gray-500:#64748b;--gray-600:#475569;--gray-800:#1e293b}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--gray-100);min-height:100vh;color:var(--gray-800)}
.hidden{display:none!important}
.login-page{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(135deg,var(--primary),var(--primary-light))}
.login-header{padding:60px 24px 40px;text-align:center;color:#fff}
.login-logo{font-size:64px;margin-bottom:16px}
.login-header h1{font-size:28px;font-weight:800}
.login-header p{opacity:.9;font-size:14px;margin-top:8px}
.login-card{flex:1;background:#fff;border-radius:32px 32px 0 0;padding:32px 24px}
.login-card h2{font-size:22px;margin-bottom:24px;text-align:center}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:14px;font-weight:600;color:var(--gray-600);margin-bottom:8px}
.input-box{position:relative}
.input-box .icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:20px}
.input-box input{width:100%;padding:16px 16px 16px 52px;border:2px solid var(--gray-200);border-radius:14px;font-size:16px;background:var(--gray-50)}
.input-box input:focus{outline:none;border-color:var(--primary);background:#fff}
.btn-login{width:100%;padding:18px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer}
.btn-login:disabled{background:var(--gray-400)}
.login-error{background:#fef2f2;border:1px solid #fecaca;color:var(--danger);padding:14px;border-radius:12px;margin-bottom:20px;font-size:14px;display:none}
.app{display:none;min-height:100vh;padding-bottom:100px}
.app.active{display:block}
.header{background:#fff;padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.header-top{display:flex;justify-content:space-between;align-items:center}
.header-user{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
.user-info h1{font-size:16px;font-weight:700}
.user-info .role{font-size:13px;color:var(--gray-500)}
.header-actions{display:flex;gap:8px}
.header-btn{width:44px;height:44px;border-radius:12px;background:var(--gray-100);border:none;font-size:20px;cursor:pointer}
.header-btn.danger{background:#fef2f2;color:var(--danger)}
.status-bar{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;padding:8px 16px;background:var(--gray-50);border-radius:10px;font-size:13px;color:var(--gray-600)}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
.status-dot.online{background:var(--success)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:8px 12px 24px;display:flex;justify-content:space-around;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:1000}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 16px;border-radius:14px;background:none;border:none;color:var(--gray-400);font-size:12px;font-weight:600;cursor:pointer;position:relative}
.nav-btn .nav-icon{font-size:24px}
.nav-btn.active{color:var(--primary);background:#eff6ff}
.notif-badge{position:absolute;top:0;right:0;background:#ef4444;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:none;align-items:center;justify-content:center;padding:0 5px}
.notif-badge.show{display:flex}
.page{display:none;padding:20px;padding-bottom:120px}
.page.active{display:block}
.page-title{font-size:22px;font-weight:800;margin-bottom:20px}
.card{background:#fff;border-radius:18px;padding:18px;margin-bottom:14px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.card-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.card-icon.blue{background:#dbeafe}
.card-icon.green{background:#d1fae5}
.card-icon.red{background:#fee2e2}
.card-icon.purple{background:#ede9fe}
.card-icon.orange{background:#fef3c7}
.card-title{font-size:16px;font-weight:700}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 4px 15px rgba(0,0,0,.06)}
.stat-value{font-size:32px;font-weight:800;color:var(--primary)}
.stat-label{font-size:13px;color:var(--gray-500);margin-top:4px}
.stat-card.warning .stat-value{color:var(--warning)}
.stat-card.success .stat-value{color:var(--success)}
.stat-card.danger .stat-value{color:var(--danger)}
.form-select,.form-input,.form-textarea{width:100%;padding:14px 16px;border:2px solid var(--gray-200);border-radius:12px;font-size:16px;background:var(--gray-50)}
.form-select:focus,.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--primary);background:#fff}
.form-textarea{resize:none;min-height:100px}
.form-label{font-size:14px;font-weight:600;color:var(--gray-600);margin-bottom:8px;display:block}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{padding:12px 18px;background:#e0e7ff;border:2px solid #818cf8;border-radius:30px;font-size:15px;font-weight:600;color:#3730a3;cursor:pointer}
.chip.selected{background:var(--primary);border-color:var(--primary);color:#fff}
.tech-group{margin-bottom:16px}
.tech-group-title{font-size:13px;font-weight:700;color:var(--gray-500);text-transform:uppercase;margin-bottom:8px;padding-left:4px}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.tech-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#f0f9ff;border:2px solid #7dd3fc;border-radius:12px;cursor:pointer}
.tech-item.selected{border-color:var(--primary);background:#eff6ff}
.tech-item input{width:20px;height:20px;accent-color:var(--primary)}
.tech-name{font-size:14px;font-weight:600;flex:1}
.timer-card{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;border-radius:18px;padding:24px;text-align:center;margin-bottom:16px}
.timer-label{font-size:14px;opacity:.9;margin-bottom:10px}
.timer-display{font-size:48px;font-weight:800;font-family:'Courier New',monospace}
.timer-buttons{display:flex;justify-content:center;gap:12px;margin-top:16px}
.timer-btn{padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px}
.timer-btn.start{background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.4)}
.timer-btn.reset{background:rgba(0,0,0,.2);color:#fff}
.di-card{background:#fff;border-radius:18px;padding:18px;margin-bottom:14px;box-shadow:0 4px 15px rgba(0,0,0,.06);border-left:5px solid var(--danger);cursor:pointer;transition:transform 0.2s}
.di-card:active{transform:scale(0.98)}
.di-card.done{border-left-color:var(--success)}
.di-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.di-id{font-size:17px;font-weight:700;color:var(--danger)}
.di-card.done .di-id{color:var(--success)}
.di-date{font-size:12px;color:var(--gray-400)}
.di-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
.di-badge.waiting{background:#fef3c7;color:#b45309}
.di-badge.done{background:#d1fae5;color:#059669}
.di-machine{font-size:16px;font-weight:600;margin-bottom:6px}
.di-info{font-size:14px;color:var(--gray-600);margin-bottom:4px}
.di-actions{display:flex;gap:10px;margin-top:14px}
.di-btn{flex:1;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.di-btn.primary{background:var(--primary);color:#fff}
.di-btn.success{background:var(--success);color:#fff}
.kpi-box{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:16px;padding:16px;text-align:center;border:1px solid #bae6fd}
.kpi-value{font-size:28px;font-weight:800;color:var(--primary);margin-bottom:4px}
.kpi-label{font-size:14px;font-weight:700;color:var(--gray-700)}
.kpi-desc{font-size:11px;color:var(--gray-500);margin-top:4px}
.bt-card{background:linear-gradient(135deg,var(--warning),#d97706);color:#fff;border-radius:18px;padding:18px;margin-bottom:14px;cursor:pointer}
.bt-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.bt-id{font-size:19px;font-weight:800}
.bt-ref{font-size:13px;opacity:.8}
.bt-section{background:rgba(255,255,255,.15);border-radius:12px;padding:12px;margin-bottom:10px}
.bt-section-title{font-size:12px;opacity:.7;text-transform:uppercase;margin-bottom:4px}
.bt-section-value{font-weight:600;font-size:15px}
.bt-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bt-statut{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600}
.bt-statut.en-cours{background:#dbeafe;color:#1e40af}
.bt-statut.attente{background:#fef3c7;color:#92400e}
.bt-statut.termine{background:#d1fae5;color:#065f46}
.bt-statut.valide{background:#ede9fe;color:#5b21b6}
.tabs{display:flex;background:var(--gray-100);border-radius:16px;padding:6px;margin-bottom:20px;gap:6px}
.tab-btn{flex:1;border:none;background:transparent;font-size:15px;font-weight:600;color:var(--gray-500);cursor:pointer;border-radius:12px;min-height:56px;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;padding:12px 8px}
.tab-btn.active{background:#fff;color:var(--primary);box-shadow:0 2px 10px rgba(0,0,0,.08)}
.tab-btn:active{transform:scale(0.97)}
.tab-badge{background:var(--danger);color:#fff;font-size:11px;padding:3px 9px;border-radius:10px}
.tab-content{display:none}
.tab-content.active{display:block}
.list-empty{padding:50px 24px;text-align:center;color:var(--gray-400)}
.list-empty .empty-icon{font-size:56px;margin-bottom:14px}
.search-box{position:relative;margin-bottom:16px}
.search-box .search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:20px;color:var(--gray-400)}
.search-box input{width:100%;padding:16px 16px 16px 52px;border:2px solid var(--gray-200);border-radius:14px;font-size:16px;background:#fff}
.preview-box{background:var(--gray-800);color:#fff;padding:16px;border-radius:14px;font-family:'Courier New',monospace;font-size:13px;white-space:pre-wrap;line-height:1.6}
.success-box{text-align:center;padding:40px 24px;background:#d1fae5;border-radius:18px;margin-bottom:16px}
.success-icon{font-size:60px;margin-bottom:14px}
.success-box h3{color:var(--success);font-size:20px;margin-bottom:8px}
.success-id{font-size:18px;font-weight:700;color:var(--gray-800);margin-top:14px;font-family:'Courier New',monospace}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:flex-end;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s}
.modal.show{opacity:1;pointer-events:auto}
.modal-content{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:24px;transform:translateY(100%);transition:transform .3s}
.modal.show .modal-content{transform:translateY(0)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h3{font-size:20px;font-weight:700}
.modal-close{width:40px;height:40px;border-radius:50%;background:var(--gray-100);border:none;font-size:22px;cursor:pointer}
.action-bar{position:fixed;bottom:100px;left:0;right:0;padding:16px 20px;background:linear-gradient(transparent,var(--gray-100) 30%);z-index:500;display:none}
.action-bar.show{display:block}
.action-buttons{display:flex;gap:12px}
.btn{flex:1;padding:16px;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
.btn:disabled{background:var(--gray-400)!important;cursor:not-allowed}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-whatsapp{width:60px;flex:none;background:#25d366;color:#fff;border-radius:16px}
.toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--gray-800);color:#fff;padding:14px 28px;border-radius:30px;font-size:15px;font-weight:600;z-index:3000;opacity:0;transition:all .3s}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.statut-workflow{background:var(--gray-50);border-radius:14px;padding:16px;margin-bottom:20px}
.statut-title{font-size:13px;color:var(--gray-500);margin-bottom:12px;text-transform:uppercase;font-weight:600}
.statut-steps{display:flex;align-items:center;flex-wrap:wrap;gap:8px;justify-content:center}
.statut-step{background:#fff;border:2px solid var(--gray-200);border-radius:10px;padding:10px 14px;font-size:13px;font-weight:600}
.statut-step.active{border-color:var(--primary);background:var(--primary);color:#fff}
.statut-step.completed{border-color:var(--success);background:#d1fae5;color:var(--success)}
.statut-arrow{color:var(--gray-400);font-size:16px}
.validation-info{background:#fef3c7;padding:10px;border-radius:8px;margin-top:12px;font-size:13px}
.photo-upload{text-align:center}
.photo-btn{width:100%;padding:20px;border:2px dashed var(--gray-200);border-radius:14px;background:var(--gray-50);color:var(--gray-600);font-size:16px;cursor:pointer}
.photo-preview{position:relative;margin-top:12px;display:inline-block}
.photo-preview img{max-width:100%;max-height:200px;border-radius:12px}
.photo-remove{position:absolute;top:-8px;right:-8px;width:28px;height:28px;background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:16px;cursor:pointer}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="login-page" id="loginPage">
<div class="login-header"><div class="login-logo">ğŸ­</div><h1>GMAO BAHIA</h1><p>v8.4 - OptimisÃ©</p></div>
<div class="login-card">
<h2>Connexion</h2>
<div class="login-error" id="loginError"></div>
<div class="form-group"><label>Identifiant</label><div class="input-box"><span class="icon">ğŸ‘¤</span><input type="text" id="loginUser" placeholder="Identifiant"></div></div>
<div class="form-group"><label>Mot de passe</label><div class="input-box"><span class="icon">ğŸ”’</span><input type="password" id="loginPass" placeholder="Mot de passe"></div></div>
<button class="btn-login" id="btnLogin">ğŸš€ Connexion</button>
</div>
</div>
<div class="app" id="mainApp">
<header class="header">
<div class="header-top">
<div class="header-user"><div class="avatar" id="userAvatar">A</div><div class="user-info"><h1 id="userName">Utilisateur</h1><div class="role" id="userRole">-</div></div></div>
<div class="header-actions"><button class="header-btn" id="btnRefresh">ğŸ”„</button><button class="header-btn danger" id="btnLogout">ğŸšª</button></div>
</div>
<div class="status-bar"><div class="status-dot" id="statusDot"></div><span id="statusText">Connexion...</span></div>
</header>
<div class="page active" id="pageHome">
<h2 class="page-title">ğŸ“Š Tableau de bord</h2>
<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statDI">0</div><div class="stat-label">DI en attente</div></div>
<div class="stat-card success"><div class="stat-value" id="statBT">0</div><div class="stat-label">BT en cours</div></div>
<div class="stat-card warning"><div class="stat-value" id="statTermine">0</div><div class="stat-label">Ã€ valider</div></div>
<div class="stat-card danger"><div class="stat-value" id="statRetard">0</div><div class="stat-label">En retard</div></div>
</div>
<div class="card" style="margin-top:16px">
<div class="card-header"><div class="card-icon blue">ğŸ“ˆ</div><div class="card-title">Indicateurs Performance</div></div>
<div class="stats-grid" style="grid-template-columns:1fr 1fr;margin-top:12px">
<div class="kpi-box"><div class="kpi-value" id="kpiMTBF">--</div><div class="kpi-label">MTBF (h)</div><div class="kpi-desc">Temps moyen entre pannes</div></div>
<div class="kpi-box"><div class="kpi-value" id="kpiMTTR">--</div><div class="kpi-label">MTTR (min)</div><div class="kpi-desc">Temps moyen de rÃ©paration</div></div>
</div>
<div class="stats-grid" style="grid-template-columns:1fr 1fr;margin-top:12px">
<div class="kpi-box"><div class="kpi-value" id="kpiDispo">--</div><div class="kpi-label">DisponibilitÃ© %</div><div class="kpi-desc">MTBF/(MTBF+MTTR)</div></div>
<div class="kpi-box"><div class="kpi-value" id="kpiNbPannes">0</div><div class="kpi-label">Pannes (30j)</div><div class="kpi-desc">Nombre total</div></div>
</div>
</div>
<div class="card" style="margin-top:16px"><div class="card-header"><div class="card-icon orange">ğŸ“‹</div><div><div class="card-title">ActivitÃ© rÃ©cente</div></div></div><div id="recentActivity"><div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucune activitÃ©</div></div></div>
</div>
<div class="page" id="pageSignal">
<h2 class="page-title">ğŸš¨ Signalement</h2>
<div class="tabs"><button class="tab-btn active" data-tab="new">â• Nouveau</button><button class="tab-btn" data-tab="history">ğŸ“œ Mes DI<span class="tab-badge" id="myDICount">0</span></button></div>
<div class="tab-content active" id="tabSignalNew">
<div class="card"><div class="card-header"><div class="card-icon purple">ğŸ•</div><div class="card-title">Horaires</div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div><label class="form-label">Heure signalement *</label><div style="display:flex;gap:8px"><input type="time" class="form-input" id="heureSignal" style="flex:1;font-size:18px;text-align:center;padding:14px"><button type="button" class="btn btn-secondary" onclick="setCurrentTime('heureSignal')" style="padding:14px">â±ï¸</button></div></div>
<div><label class="form-label">ArrivÃ©e maintenance</label><div style="display:flex;gap:8px"><input type="time" class="form-input" id="heureFinOp" style="flex:1;font-size:18px;text-align:center;padding:14px"><button type="button" class="btn btn-secondary" onclick="setCurrentTime('heureFinOp')" style="padding:14px">â±ï¸</button></div></div>
</div>
</div>
<div class="card" id="step1"><div class="card-header"><div class="card-icon blue">1ï¸âƒ£</div><div class="card-title">OpÃ©rateur</div></div><div style="background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:14px 18px;border-radius:14px;display:flex;align-items:center;gap:12px"><span style="font-size:28px">ğŸ‘¤</span><div><div style="font-weight:700" id="opName">-</div><div style="font-size:13px;opacity:.9">OpÃ©rateur</div></div></div></div>
<div class="card" id="step2"><div class="card-header"><div class="card-icon blue">2ï¸âƒ£</div><div class="card-title">Ligne</div></div><div class="chips" id="lignesChips"></div></div>
<div class="card hidden" id="step3"><div class="card-header"><div class="card-icon blue">3ï¸âƒ£</div><div class="card-title">Machine</div></div><div class="chips" id="machinesChips"></div></div>
<div class="card hidden" id="step4"><div class="card-header"><div class="card-icon blue">4ï¸âƒ£</div><div class="card-title">Zone</div></div><div class="chips" id="zonesChips"></div></div>
<div class="card hidden" id="step5"><div class="card-header"><div class="card-icon blue">5ï¸âƒ£</div><div class="card-title">Composant</div></div><div class="chips" id="composantsChips"></div></div>
<div class="card hidden" id="step6"><div class="card-header"><div class="card-icon red">6ï¸âƒ£</div><div class="card-title">Anomalie</div></div><div class="chips" id="anomaliesChips"></div></div>
<div class="card hidden" id="step7"><div class="card-header"><div class="card-icon purple">7ï¸âƒ£</div><div class="card-title">Description standardisÃ©e</div></div><select class="form-select" id="descriptionSelect"><option value="">-- SÃ©lectionner --</option></select></div>
<div class="card hidden" id="step8"><div class="card-header"><div class="card-icon orange">8ï¸âƒ£</div><div class="card-title">Techniciens</div></div><div id="techsContainer"></div></div>
<div class="card hidden" id="step9"><div class="card-header"><div class="card-icon green">9ï¸âƒ£</div><div class="card-title">Commentaire</div></div><textarea class="form-textarea" id="commentInput" placeholder="Commentaire libre..."></textarea></div>
<div class="card hidden" id="step10"><div class="card-header"><div class="card-icon blue">ğŸ“·</div><div class="card-title">Photo (optionnel)</div></div><div class="photo-upload"><input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none"><button class="photo-btn" id="btnTakePhoto">ğŸ“· Prendre photo</button><div class="photo-preview hidden" id="photoPreview"><img id="photoImg" src=""><button class="photo-remove" id="btnRemovePhoto">âœ•</button></div></div></div>
<div class="card hidden" id="previewCard"><div class="card-header"><div class="card-icon orange">ğŸ‘ï¸</div><div class="card-title">AperÃ§u</div></div><div class="preview-box" id="previewBox"></div></div>
<div class="success-box hidden" id="successBox"><div class="success-icon">âœ…</div><h3>DI EnregistrÃ©e!</h3><p>Envoyez WhatsApp maintenant</p><div class="success-id" id="successId">DI-XXXXXX-X</div></div>
</div>
<div class="tab-content" id="tabSignalHistory"><div id="myDIList"><div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun signalement</div></div></div>
</div>
<div class="page" id="pageMaint">
<h2 class="page-title">ğŸ”§ Maintenance</h2>
<div class="tabs">
<button class="tab-btn active" data-tab="di">ğŸ“‹ DI Ã  traiter <span class="tab-badge" id="diWaitingCount">0</span></button>
<button class="tab-btn" data-tab="bt">ğŸ“„ Bons de Travail <span class="tab-badge" id="btCount">0</span></button>
</div>
<div class="tab-content active" id="tabMaintDI"><div id="diWaitingList"><div class="list-empty"><div class="empty-icon">âœ…</div>Aucune DI</div></div></div>
<div class="tab-content" id="tabMaintBT"><div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" id="searchBT" placeholder="Rechercher BT..."></div><div id="btList"><div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun BT</div></div></div>
</div>
<div class="page" id="pageHistorique">
<h2 class="page-title">ğŸ“‹ Historique</h2>
<div class="tabs">
<button class="tab-btn active" data-tab="histDI">ğŸ“ DI</button>
<button class="tab-btn" data-tab="histBT">ğŸ“„ BT</button>
</div>
<div class="tab-content active" id="tabHistDI"><div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" id="searchHistDI" placeholder="Rechercher..."></div><div id="histDIList"><div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucune DI</div></div></div>
<div class="tab-content" id="tabHistBT"><div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" id="searchHistBT" placeholder="Rechercher..."></div><div id="histBTList"><div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun BT</div></div></div>
</div>
<div class="page" id="pageValidation">
<h2 class="page-title">âœ”ï¸ Validation BT</h2>
<div id="btToValidateList"><div class="list-empty"><div class="empty-icon">âœ…</div>Aucun BT Ã  valider</div></div>
</div>
<nav class="bottom-nav" id="bottomNav">
<button class="nav-btn active" data-page="pageHome"><span class="nav-icon">ğŸ </span><span>Accueil</span></button>
<button class="nav-btn" data-page="pageSignal" id="navSignal"><span class="nav-icon">ğŸš¨</span><span>Signaler</span></button>
<button class="nav-btn" data-page="pageMaint" id="navMaint"><span class="nav-icon">ğŸ”§</span><span>Maintenance</span><span class="notif-badge" id="navMaintBadge">0</span></button>
<button class="nav-btn" data-page="pageHistorique" id="navHistorique"><span class="nav-icon">ğŸ“‹</span><span>Historique</span></button>
<button class="nav-btn" data-page="pageValidation" id="navValidation"><span class="nav-icon">âœ”ï¸</span><span>Valider</span><span class="notif-badge" id="navValidBadge">0</span></button>
</nav>
<div class="action-bar" id="signalActionBar"><div class="action-buttons"><button class="btn btn-primary" id="btnSaveDI" disabled>ğŸ’¾ Enregistrer</button><button class="btn btn-whatsapp" id="btnWhatsApp" disabled>ğŸ“±</button></div></div>
</div>
<div class="modal" id="modalTraitement">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ”§ Traiter DI</h3><button class="modal-close" onclick="closeModal('modalTraitement')">âœ•</button></div>
<div class="di-card" id="modalDIInfo"></div>
<div class="form-group"><label class="form-label">Cause *</label><select class="form-select" id="traitCause"><option value="">-- SÃ©lectionner --</option><option>Usure normale</option><option>DÃ©faut matÃ©riel</option><option>Erreur opÃ©rateur</option><option>Manque maintenance</option><option>Autre</option></select></div>
<div class="form-group"><label class="form-label">Diagnostic *</label><textarea class="form-textarea" id="traitDiag" placeholder="Diagnostic..."></textarea></div>
<div class="form-group"><label class="form-label">Type action *</label><select class="form-select" id="traitAction"><option value="">-- SÃ©lectionner --</option><option>Correctif</option><option>PrÃ©ventif</option><option>AmÃ©lioratif</option></select></div>
<div class="form-group"><label class="form-label">DÃ©tail action *</label><textarea class="form-textarea" id="traitDetail" placeholder="Action rÃ©alisÃ©e..."></textarea></div>
<div class="form-group"><label class="form-label">PiÃ¨ces utilisÃ©es</label><textarea class="form-textarea" id="traitPieces" placeholder="Ex: Joint torique x2, Roulement SKF 6205..."></textarea></div>
<button class="btn btn-success" style="width:100%;margin-top:16px" id="btnCloseDI">âœ… ClÃ´turer et GÃ©nÃ©rer BT</button>
</div>
</div>
<div class="modal" id="modalStatutBT">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ“Š Changer Statut</h3><button class="modal-close" onclick="closeModal('modalStatutBT')">âœ•</button></div>
<div class="bt-card" id="modalStatutBTInfo"></div>
<div class="statut-workflow"><div class="statut-title">Workflow:</div><div class="statut-steps"><div class="statut-step" data-statut="En cours">ğŸ”§ En cours</div><div class="statut-arrow">â†’</div><div class="statut-step" data-statut="En attente piÃ¨ces">ğŸ“¦ Attente</div><div class="statut-arrow">â†’</div><div class="statut-step" data-statut="TerminÃ©">âœ… TerminÃ©</div><div class="statut-arrow">â†’</div><div class="statut-step" data-statut="ValidÃ©">âœ”ï¸ ValidÃ©</div></div></div>
<div class="form-group"><label class="form-label">Nouveau statut</label><select class="form-select" id="selectNewStatut" onchange="onStatutChange()"></select></div>
<div id="horairesIntervention" class="card" style="background:var(--gray-50);display:none;margin:16px 0">
<div class="card-header" style="margin-bottom:12px"><div class="card-icon purple">ğŸ•</div><div class="card-title">Horaires Intervention</div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div><label class="form-label">Heure arrivÃ©e *</label><div style="display:flex;gap:8px"><input type="time" class="form-input" id="btHeureArrivee" style="flex:1"><button type="button" class="btn btn-secondary" onclick="setCurrentTime('btHeureArrivee')" style="padding:12px">â±ï¸</button></div></div>
<div><label class="form-label">Heure fin *</label><div style="display:flex;gap:8px"><input type="time" class="form-input" id="btHeureFin" style="flex:1"><button type="button" class="btn btn-secondary" onclick="setCurrentTime('btHeureFin')" style="padding:12px">â±ï¸</button></div></div>
</div>
</div>
<div class="form-group"><label class="form-label">Commentaire</label><textarea class="form-textarea" id="statutComment" placeholder="Optionnel..."></textarea></div>
<div class="validation-info" id="validationInfo">âš ï¸ Validation rÃ©servÃ©e au <strong>Chef d'Ã©quipe</strong></div>
<button class="btn btn-success" style="width:100%;margin-top:16px" id="btnSaveStatut">ğŸ’¾ Valider</button>
</div>
</div>
<div class="modal" id="modalBT">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ“„ DÃ©tail BT</h3><button class="modal-close" onclick="closeModal('modalBT')">âœ•</button></div>
<div id="modalBTContent"></div>
</div>
</div>
<div class="modal" id="modalDI">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ“‹ DÃ©tail DI</h3><button class="modal-close" onclick="closeModal('modalDI')">âœ•</button></div>
<div id="modalDIContent"></div>
</div>
</div>
<div class="modal" id="modalEditDI">
<div class="modal-content">
<div class="modal-header"><h3>âœï¸ Modifier DI</h3><button class="modal-close" onclick="closeModal('modalEditDI')">âœ•</button></div>
<div class="form-group"><label class="form-label">Ligne</label><select class="form-select" id="editDILigne"></select></div>
<div class="form-group"><label class="form-label">Machine</label><select class="form-select" id="editDIMachine"></select></div>
<div class="form-group"><label class="form-label">Zone</label><select class="form-select" id="editDIZone"></select></div>
<div class="form-group"><label class="form-label">Composant</label><select class="form-select" id="editDIComposant"></select></div>
<div class="form-group"><label class="form-label">Anomalie</label><select class="form-select" id="editDIAnomalie"></select></div>
<div class="form-group"><label class="form-label">Commentaire</label><textarea class="form-textarea" id="editDIComment" placeholder="Commentaire..."></textarea></div>
<button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveEditDI()">ğŸ’¾ Sauvegarder</button>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
const API_URL='https://script.google.com/macros/s/AKfycbyYb7YD_6g28upbmQjOBegU98I2MFbf9jTQZF3HCf7_LNwZrfBHynfr1k1PAY9gKCPL/exec';
let user=null,db={machines:[],zones:[],composants:[],anomalies:[],techniciens:[],descriptions:[]};
let allDI=[],allBT=[],signalData={ligne:'',machine:'',zone:'',composant:'',anomalie:'',description:'',techniciens:[]};
let currentDI=null,currentBT=null,photoData=null;

document.addEventListener('DOMContentLoaded',()=>{
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
const saved=localStorage.getItem('gmao_user');
if(saved){try{user=JSON.parse(saved);showApp();}catch(e){localStorage.removeItem('gmao_user');}}
document.getElementById('btnLogin').onclick=doLogin;
document.getElementById('loginPass').onkeypress=e=>{if(e.key==='Enter')doLogin();};
document.getElementById('btnRefresh').onclick=()=>{loadAllData();toast('ğŸ”„ ActualisÃ©');};
document.getElementById('btnLogout').onclick=doLogout;
document.getElementById('btnSaveDI').onclick=saveDI;
document.getElementById('btnWhatsApp').onclick=sendWhatsApp;
document.getElementById('btnSaveDI').onclick=saveDI;
document.getElementById('commentInput').oninput=updatePreview;
document.getElementById('descriptionSelect').onchange=()=>{showStep(8);updatePreview();};
document.getElementById('searchBT').oninput=()=>renderBTList(document.getElementById('searchBT').value);
document.getElementById('searchHistDI').oninput=renderHistoriqueDI;
document.getElementById('searchHistBT').oninput=renderHistoriqueBT;
document.getElementById('btnCloseDI').onclick=closeDI;
document.getElementById('btnSaveStatut').onclick=saveNewStatut;
document.getElementById('btnTakePhoto').onclick=()=>document.getElementById('photoInput').click();
document.getElementById('photoInput').onchange=handlePhoto;
document.getElementById('btnRemovePhoto').onclick=removePhoto;
document.querySelectorAll('.nav-btn').forEach(btn=>{btn.onclick=()=>{
const page=btn.dataset.page;
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
document.querySelectorAll('.action-bar').forEach(a=>a.classList.remove('show'));
document.getElementById(page).classList.add('active');
btn.classList.add('active');
if(page==='pageSignal')document.getElementById('signalActionBar').classList.add('show');
if(page==='pageHistorique'){renderHistoriqueDI();renderHistoriqueBT();}
if(page==='pageValidation')renderBTToValidate();
};});
document.querySelectorAll('.tabs .tab-btn').forEach(btn=>{btn.onclick=()=>{
const parent=btn.closest('.page'),tab=btn.dataset.tab;
parent.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
parent.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
btn.classList.add('active');
if(tab==='new'){document.getElementById('tabSignalNew').classList.add('active');document.getElementById('signalActionBar').classList.add('show');}
else if(tab==='history'){document.getElementById('tabSignalHistory').classList.add('active');document.getElementById('signalActionBar').classList.remove('show');renderMyDIs();}
else if(tab==='di')document.getElementById('tabMaintDI').classList.add('active');
else if(tab==='bt')document.getElementById('tabMaintBT').classList.add('active');
else if(tab==='histDI'){document.getElementById('tabHistDI').classList.add('active');renderHistoriqueDI();}
else if(tab==='histBT'){document.getElementById('tabHistBT').classList.add('active');renderHistoriqueBT();}
};});
document.querySelectorAll('.modal').forEach(m=>m.onclick=e=>{if(e.target===m)m.classList.remove('show');});
});

async function api(action,params={}){
try{const c=new AbortController(),t=setTimeout(()=>c.abort(),10000);
const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action,...params}),signal:c.signal});
clearTimeout(t);return await r.json();}
catch(e){return{success:false,error:e.name==='AbortError'?'Timeout':e.message};}}

async function doLogin(){
const username=document.getElementById('loginUser').value.trim(),password=document.getElementById('loginPass').value.trim();
const errorEl=document.getElementById('loginError');
if(!username||!password){errorEl.textContent='Remplir tous les champs';errorEl.style.display='block';return;}
errorEl.style.display='none';
const btn=document.getElementById('btnLogin');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>';
const result=await api('login',{username,password});
if(result.success){user=result.user;localStorage.setItem('gmao_user',JSON.stringify(user));showApp();}
else{errorEl.textContent=result.error||'Erreur';errorEl.style.display='block';}
btn.disabled=false;btn.textContent='ğŸš€ Connexion';}

function doLogout(){if(confirm('DÃ©connexion?')){user=null;localStorage.removeItem('gmao_user');document.getElementById('loginPage').style.display='flex';document.getElementById('mainApp').classList.remove('active');}}

async function showApp(){
document.getElementById('loginPage').style.display='none';
document.getElementById('mainApp').classList.add('active');
document.getElementById('userAvatar').textContent=user.nom.charAt(0).toUpperCase();
document.getElementById('userName').textContent=user.nom;
document.getElementById('userRole').textContent=user.role;
document.getElementById('opName').textContent=user.nom;
applyRoleRestrictions();await loadData();}

function applyRoleRestrictions(){
const role=(user.role||'').toLowerCase();
const navSignal=document.getElementById('navSignal');
const navMaint=document.getElementById('navMaint');
const navHistorique=document.getElementById('navHistorique');
const navValidation=document.getElementById('navValidation');
// Par dÃ©faut: tout visible sauf Validation
navSignal.style.display='flex';
navMaint.style.display='flex';
navHistorique.style.display='flex';
navValidation.style.display='none';
if(role==='technicien'){
// Technicien: pas de signalement
navSignal.style.display='none';
}else if(role==='chef_equipe'||role==='chef equipe'){
// Chef Ã©quipe: Signaler, Historique, Valider (pas Maintenance)
navMaint.style.display='none';
navValidation.style.display='flex';
}else if(role==='operateur'||role==='opÃ©rateur'){
// OpÃ©rateur: Signaler, Historique (pas Maintenance ni Validation)
navMaint.style.display='none';
}
// Admin: tout visible
}

async function loadData(){
setStatus(false,'Chargement...');
const result=await api('getData');
if(result.success){db=result;setStatus(true,'ConnectÃ©');initSignalForm();await loadAllData();}
else{setStatus(false,'Erreur');toast('âŒ Erreur connexion');}}

async function loadAllData(){
console.log('loadAllData appelÃ©');
const[diResult,btResult]=await Promise.all([api('getAnomalies'),api('getBTs')]);
console.log('DI Result:', diResult);
console.log('BT Result:', btResult);
if(diResult.success){allDI=diResult.data||[];console.log('allDI:', allDI.length, 'enregistrements');}
else{console.error('Erreur DI:', diResult.error);}
if(btResult.success){allBT=btResult.data||[];console.log('allBT:', allBT.length, 'enregistrements');}
else{console.error('Erreur BT:', btResult.error);}
updateDashboard();renderDIList();renderBTList();renderMyDIs();renderHistoriqueDI();renderHistoriqueBT();}

function setStatus(online,text){document.getElementById('statusDot').className='status-dot'+(online?' online':'');document.getElementById('statusText').textContent=text;}

function updateDashboard(){
const diWaiting=allDI.filter(d=>d.Statut==='En attente').length;
const btEnCours=allBT.filter(b=>b.Statut==='En cours').length;
const btTermine=allBT.filter(b=>b.Statut==='TerminÃ©').length;
const btTotal=allBT.length;
console.log('updateDashboard - DI en attente:',diWaiting,'BT en cours:',btEnCours,'BT terminÃ©:',btTermine);
// Stats accueil
document.getElementById('statDI').textContent=diWaiting;
document.getElementById('statBT').textContent=btEnCours;
document.getElementById('statTermine').textContent=btTermine;
document.getElementById('diWaitingCount').textContent=diWaiting;
document.getElementById('myDICount').textContent=allDI.filter(d=>d.Operateur===user.nom).length;
// Badge BT
const btCountEl=document.getElementById('btCount');
if(btCountEl)btCountEl.textContent=btTotal;
// Badge rouge Maintenance
const maintBadge=document.getElementById('navMaintBadge');
console.log('Badge Maintenance trouvÃ©:',!!maintBadge,'diWaiting:',diWaiting);
if(maintBadge){
maintBadge.textContent=diWaiting;
if(diWaiting>0){maintBadge.classList.add('show');console.log('Badge show ajoutÃ©');}else{maintBadge.classList.remove('show');}
}
// Badge rouge Validation  
const validBadge=document.getElementById('navValidBadge');
if(validBadge){
validBadge.textContent=btTermine;
if(btTermine>0){validBadge.classList.add('show');}else{validBadge.classList.remove('show');}
}
// Calcul MTBF / MTTR
calculateKPIs();
// ActivitÃ© rÃ©cente
const recent=[...allDI,...allBT].sort((a,b)=>parseDate(b.Date)-parseDate(a.Date)).slice(0,5);
if(recent.length){
document.getElementById('recentActivity').innerHTML=recent.map(item=>{
const isDI=item.ID&&item.ID.startsWith('DI');
const statut=item.Statut||'';
const statutClass=statut==='En attente'?'waiting':(statut==='ClÃ´turÃ©'||statut==='ValidÃ©')?'done':'';
return`<div style="padding:12px 0;border-bottom:1px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center">
<div><div style="font-weight:600">${isDI?'ğŸš¨':'ğŸ“„'} ${item.ID||item.BT_ID}</div><div style="font-size:13px;color:var(--gray-500)">${item.Machine||'-'} - ${item.Date||''}</div></div>
<span class="di-badge ${statutClass}" style="font-size:10px">${statut}</span>
</div>`;
}).join('');
}
}

function calculateKPIs(){
// Filtrer BT des 30 derniers jours avec temps d'intervention
const now=new Date();
const thirtyDaysAgo=new Date(now.getTime()-30*24*60*60*1000);
const btWithTime=allBT.filter(bt=>{
const btDate=parseDate(bt.Date);
return btDate>=thirtyDaysAgo && bt.Heure_Arrivee && bt.Heure_Fin;
});

// Nombre de pannes (30j)
const nbPannes=allDI.filter(di=>parseDate(di.Date)>=thirtyDaysAgo).length;
document.getElementById('kpiNbPannes').textContent=nbPannes;

if(btWithTime.length===0){
document.getElementById('kpiMTBF').textContent='--';
document.getElementById('kpiMTTR').textContent='--';
document.getElementById('kpiDispo').textContent='--';
return;
}

// Calcul MTTR (temps moyen de rÃ©paration en minutes)
let totalRepairTime=0;
btWithTime.forEach(bt=>{
const arrival=parseTime(bt.Heure_Arrivee);
const end=parseTime(bt.Heure_Fin);
if(arrival && end){
let diff=(end-arrival)/60000; // en minutes
if(diff<0)diff+=24*60; // si passage minuit
totalRepairTime+=diff;
}
});
const mttr=btWithTime.length>0?Math.round(totalRepairTime/btWithTime.length):0;
document.getElementById('kpiMTTR').textContent=mttr;

// Calcul MTBF (temps moyen entre pannes en heures)
// MTBF = Temps total disponible / Nombre de pannes
const hoursInPeriod=30*24; // 30 jours en heures
const mtbf=nbPannes>0?Math.round(hoursInPeriod/nbPannes):hoursInPeriod;
document.getElementById('kpiMTBF').textContent=mtbf;

// DisponibilitÃ© = MTBF / (MTBF + MTTR/60)
const mttrHours=mttr/60;
const dispo=mtbf>0?Math.round((mtbf/(mtbf+mttrHours))*100):100;
document.getElementById('kpiDispo').textContent=dispo+'%';
}

function parseTime(timeStr){
if(!timeStr)return null;
const parts=String(timeStr).split(':');
if(parts.length>=2){
const d=new Date();
d.setHours(parseInt(parts[0]),parseInt(parts[1]),0,0);
return d;
}
return null;
}

function parseDate(d){
if(!d)return new Date(0);
if(d instanceof Date)return d;
if(typeof d==='number')return new Date(d);
if(typeof d==='string'){
const p=d.split('/');
if(p.length===3)return new Date(p[2],p[1]-1,p[0]);
return new Date(d);
}
return new Date(0);
}

function initSignalForm(){
const lignes=[...new Set((db.machines||[]).map(m=>m.Ligne).filter(Boolean))];
document.getElementById('lignesChips').innerHTML=lignes.map(l=>`<div class="chip" onclick="selectLigne(this)" data-value="${l}">${l}</div>`).join('');
const techsByFonction={};
(db.techniciens||[]).forEach(t=>{const f=t.Fonction||'Autres';if(!techsByFonction[f])techsByFonction[f]=[];techsByFonction[f].push(t);});
let techHTML='';
Object.entries(techsByFonction).forEach(([fonction,techs])=>{
techHTML+=`<div class="tech-group"><div class="tech-group-title">${fonction}</div><div class="tech-grid">`;
techHTML+=techs.map(t=>`<div class="tech-item" onclick="toggleTech(this)" data-name="${t.Nom}"><input type="checkbox"><span class="tech-name">${t.Nom}</span></div>`).join('');
techHTML+='</div></div>';});
document.getElementById('techsContainer').innerHTML=techHTML;
document.getElementById('anomaliesChips').innerHTML=(db.anomalies||[]).map(a=>`<div class="chip" onclick="selectAnomalie(this)" data-value="${a.Anomalie}">${a.Anomalie}</div>`).join('');
resetSignalForm();}

function selectLigne(chip){
console.log('selectLigne:', chip.dataset.value);
document.querySelectorAll('#lignesChips .chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
signalData.ligne=chip.dataset.value;
signalData.machine='';signalData.zone='';signalData.composant='';signalData.anomalie='';
hideSteps([3,4,5,6,7,8,9,10]);
document.getElementById('previewCard').classList.add('hidden');
const machines=(db.machines||[]).filter(m=>m.Ligne===signalData.ligne);
console.log('Machines trouvÃ©es:', machines.length);
document.getElementById('machinesChips').innerHTML=machines.map(m=>`<div class="chip" onclick="selectMachine(this)" data-value="${m.Machine}">${m.Machine}</div>`).join('');
showStep(3);
updatePreview();}

function selectMachine(chip){
console.log('selectMachine:', chip.dataset.value);
document.querySelectorAll('#machinesChips .chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
signalData.machine=chip.dataset.value;
signalData.zone='';signalData.composant='';signalData.anomalie='';
hideSteps([4,5,6,7,8,9,10]);
document.getElementById('previewCard').classList.add('hidden');
const zones=(db.zones||[]).filter(z=>z.Machine===signalData.machine);
console.log('Zones trouvÃ©es:', zones.length);
document.getElementById('zonesChips').innerHTML=zones.map(z=>`<div class="chip" onclick="selectZone(this)" data-value="${z.Zone}">${z.Zone}</div>`).join('');
showStep(4);
updatePreview();}

function selectZone(chip){
console.log('selectZone:', chip.dataset.value);
document.querySelectorAll('#zonesChips .chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
signalData.zone=chip.dataset.value;
signalData.composant='';signalData.anomalie='';
hideSteps([5,6,7,8,9,10]);
document.getElementById('previewCard').classList.add('hidden');
const composants=(db.composants||[]).filter(c=>c.Zone===signalData.zone);
console.log('Composants trouvÃ©s:', composants.length);
document.getElementById('composantsChips').innerHTML=composants.map(c=>`<div class="chip" onclick="selectComposant(this)" data-value="${c.Composant}">${c.Composant}</div>`).join('');
showStep(5);
updatePreview();}

function selectComposant(chip){
console.log('selectComposant:', chip.dataset.value);
document.querySelectorAll('#composantsChips .chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
signalData.composant=chip.dataset.value;
signalData.anomalie='';
hideSteps([6,7,8,9,10]);
document.getElementById('previewCard').classList.add('hidden');
showStep(6);
updatePreview();}

function selectAnomalie(chip){
console.log('selectAnomalie:', chip.dataset.value);
document.querySelectorAll('#anomaliesChips .chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
signalData.anomalie=chip.dataset.value;
const descriptions=(db.descriptions||[]).filter(d=>d.Type_Anomalie===signalData.anomalie);
const select=document.getElementById('descriptionSelect');
select.innerHTML='<option value="">-- SÃ©lectionner --</option>'+descriptions.map(d=>`<option value="${d.Description_Standard}">${d.Description_Standard}</option>`).join('');
showStep(7);showStep(8);showStep(9);showStep(10);
document.getElementById('previewCard').classList.remove('hidden');
updatePreview();}

function toggleTech(item){
const cb=item.querySelector('input');cb.checked=!cb.checked;
item.classList.toggle('selected',cb.checked);
const name=item.dataset.name;
if(cb.checked){if(!signalData.techniciens.includes(name))signalData.techniciens.push(name);}
else{signalData.techniciens=signalData.techniciens.filter(t=>t!==name);}
updatePreview();}

function showStep(n){document.getElementById('step'+n).classList.remove('hidden');}
function hideSteps(arr){arr.forEach(n=>{const el=document.getElementById('step'+n);if(el)el.classList.add('hidden');});}
function showSteps(arr){arr.forEach(n=>{const el=document.getElementById('step'+n);if(el)el.classList.remove('hidden');});}

function updatePreview(){
signalData.description=document.getElementById('descriptionSelect').value;
const comment=document.getElementById('commentInput').value;
const heureSignal=document.getElementById('heureSignal').value;
const heureFinOp=document.getElementById('heureFinOp').value;
let msg=`ğŸš¨ *DEMANDE D'INTERVENTION*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ ${user.nom}\n`;
if(heureSignal)msg+=`ğŸ• Heure signalement: ${heureSignal}\n`;
if(heureFinOp)msg+=`ğŸ• ArrivÃ©e maintenance: ${heureFinOp}\n`;
if(signalData.ligne)msg+=`ğŸ“ Ligne: ${signalData.ligne}\n`;
if(signalData.machine)msg+=`âš™ï¸ Machine: ${signalData.machine}\n`;
if(signalData.zone)msg+=`ğŸ”§ Zone: ${signalData.zone}\n`;
if(signalData.composant)msg+=`ğŸ”© Composant: ${signalData.composant}\n`;
if(signalData.anomalie)msg+=`âš ï¸ Anomalie: ${signalData.anomalie}\n`;
if(signalData.description)msg+=`ğŸ“ ${signalData.description}\n`;
if(signalData.techniciens.length)msg+=`ğŸ‘¨â€ğŸ”§ Techniciens: ${signalData.techniciens.join(', ')}\n`;
if(comment)msg+=`ğŸ’¬ ${comment}\n`;
msg+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ³ En attente`;
document.getElementById('previewBox').textContent=msg;
// Validation
const valid=signalData.ligne&&signalData.machine&&signalData.zone&&signalData.composant&&signalData.anomalie;
console.log('=== VALIDATION ===');
console.log('ligne:', signalData.ligne);
console.log('machine:', signalData.machine);
console.log('zone:', signalData.zone);
console.log('composant:', signalData.composant);
console.log('anomalie:', signalData.anomalie);
console.log('valid:', valid);
document.getElementById('btnSaveDI').disabled=!valid;
document.getElementById('btnWhatsApp').disabled=!valid;}

function resetSignalForm(){
signalData={ligne:'',machine:'',zone:'',composant:'',anomalie:'',description:'',techniciens:[]};
document.querySelectorAll('#tabSignalNew .chip').forEach(c=>c.classList.remove('selected'));
document.querySelectorAll('#techsContainer .tech-item').forEach(t=>{t.classList.remove('selected');t.querySelector('input').checked=false;});
document.getElementById('commentInput').value='';document.getElementById('descriptionSelect').value='';
document.getElementById('heureSignal').value='';document.getElementById('heureFinOp').value='';
hideSteps([3,4,5,6,7,8,9,10]);document.getElementById('previewCard').classList.add('hidden');
document.getElementById('successBox').classList.add('hidden');[1,2].forEach(n=>document.getElementById('step'+n).classList.remove('hidden'));
removePhoto();updatePreview();}

function handlePhoto(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{photoData=ev.target.result;document.getElementById('photoImg').src=photoData;document.getElementById('photoPreview').classList.remove('hidden');document.getElementById('btnTakePhoto').classList.add('hidden');};reader.readAsDataURL(file);}

function removePhoto(){photoData=null;document.getElementById('photoPreview').classList.add('hidden');document.getElementById('btnTakePhoto').classList.remove('hidden');document.getElementById('photoInput').value='';}
async function saveDI(){
let heureSignal=document.getElementById('heureSignal').value;
const heureFinOp=document.getElementById('heureFinOp').value;
// Auto-remplir l'heure si vide
if(!heureSignal){
const now=new Date();
heureSignal=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
document.getElementById('heureSignal').value=heureSignal;
}
const btn=document.getElementById('btnSaveDI');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>';
const result=await api('saveAnomalie',{operateur:user.nom,ligne:signalData.ligne,machine:signalData.machine,zone:signalData.zone,composant:signalData.composant,anomalie:signalData.anomalie,description:signalData.description,techniciens:signalData.techniciens.join(', '),heureSignal:heureSignal,heureFinOp:heureFinOp||'',commentaire:document.getElementById('commentInput').value,userId:user.id,photo:photoData||''});
if(result.success){
document.getElementById('successId').textContent=result.id;
[1,2,3,4,5,6,7,8,9,10].forEach(n=>{const el=document.getElementById('step'+n);if(el)el.classList.add('hidden');});
document.getElementById('previewCard').classList.add('hidden');
document.getElementById('successBox').classList.remove('hidden');
btn.innerHTML='â• Nouveau';btn.disabled=false;
btn.onclick=()=>{resetSignalForm();btn.innerHTML='ğŸ’¾ Enregistrer';btn.onclick=saveDI;};
toast('âœ… DI enregistrÃ©e! Envoyez WhatsApp');await loadAllData();}
else{toast('âŒ '+(result.error||'Erreur'));btn.innerHTML='ğŸ’¾ Enregistrer';btn.disabled=false;}}

function sendWhatsApp(){window.open('https://wa.me/?text='+encodeURIComponent(document.getElementById('previewBox').textContent),'_blank');}

function renderMyDIs(){
console.log('renderMyDIs - user.nom:', user.nom);
console.log('renderMyDIs - allDI operateurs:', allDI.map(d=>d.Operateur));
const myDIs=allDI.filter(di=>{
const match=di.Operateur && user.nom && di.Operateur.trim().toLowerCase()===user.nom.trim().toLowerCase();
return match;
});
console.log('renderMyDIs - myDIs:', myDIs.length);
if(!myDIs.length){document.getElementById('myDIList').innerHTML='<div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun signalement</div>';return;}
document.getElementById('myDIList').innerHTML=myDIs.map(di=>{
const canEdit=di.Statut==='En attente';
return`<div class="di-card ${di.Statut==='ClÃ´turÃ©'?'done':''}" onclick="openDIDetail('${di.ID}')">
<div class="di-header"><div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div>
<span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut}</span></div>
<div class="di-machine">âš™ï¸ ${di.Machine||'-'}</div>
<div class="di-info">ğŸ“ ${di.Ligne||'-'} | ğŸ”§ ${di.Zone||'-'}</div>
${di.BT_ID?`<div class="di-info" style="color:var(--warning)">â†’ ${di.BT_ID}</div>`:''}
${canEdit?`<div class="di-actions">
<button class="di-btn warning" onclick="event.stopPropagation();openEditDI('${di.ID}')">âœï¸ Ã‰diter</button>
<button class="di-btn" style="background:var(--danger);color:#fff" onclick="event.stopPropagation();confirmDeleteDI('${di.ID}')">ğŸ—‘ï¸</button>
</div>`:''}
</div>`;}).join('');}

function renderDIList(){
const waiting=allDI.filter(di=>di.Statut==='En attente');
if(!waiting.length){
document.getElementById('diWaitingList').innerHTML='<div class="list-empty"><div class="empty-icon">âœ…</div>Aucune DI en attente</div>';
return;
}
document.getElementById('diWaitingList').innerHTML=waiting.map(di=>`
<div class="di-card" onclick="openDIDetail('${di.ID}')">
<div class="di-header"><div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div>
<span class="di-badge waiting">En attente</span></div>
<div class="di-machine">âš™ï¸ ${di.Machine||'-'}</div>
<div class="di-info">ğŸ“ ${di.Ligne||'-'} | ğŸ”§ ${di.Zone||'-'}</div>
<div class="di-info">âš ï¸ ${di.Anomalie||'-'}</div>
<div class="di-info">ğŸ‘¤ ${di.Operateur||'-'}</div>
<div class="di-actions">
<button class="di-btn primary" onclick="event.stopPropagation();openTraitement('${di.ID}')">ğŸ”§ Traiter</button>
</div>
</div>`).join('');
}

function renderHistoriqueDI(){
const search=(document.getElementById('searchHistDI').value||'').toLowerCase();
let dis=[...allDI];
if(search){dis=dis.filter(d=>(d.ID||'').toLowerCase().includes(search)||(d.Machine||'').toLowerCase().includes(search));}
if(!dis.length){
document.getElementById('histDIList').innerHTML='<div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucune DI</div>';
return;
}
document.getElementById('histDIList').innerHTML=dis.map(di=>`
<div class="di-card ${di.Statut==='ClÃ´turÃ©'?'done':''}" onclick="openDIDetail('${di.ID}')">
<div class="di-header"><div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div>
<span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut||'-'}</span></div>
<div class="di-machine">âš™ï¸ ${di.Machine||'-'}</div>
<div class="di-info">ğŸ“ ${di.Ligne||'-'} | âš ï¸ ${di.Anomalie||'-'}</div>
${di.BT_ID?`<div class="di-info" style="color:var(--warning)">â†’ ${di.BT_ID}</div>`:''}
</div>`).join('');
}

function openDIDetail(diId){
const di=allDI.find(d=>d.ID===diId);if(!di)return;
// Trouver le BT associÃ© pour avoir les infos de traitement
const btAssocie=di.BT_ID?allBT.find(b=>b.BT_ID===di.BT_ID):null;
let validateur='-';
if(btAssocie){try{const hist=JSON.parse(btAssocie.Historique||'[]');const valid=hist.find(h=>h.statut==='ValidÃ©');if(valid)validateur=valid.user;}catch(e){}}
document.getElementById('modalDIContent').innerHTML=`
<div class="di-card ${di.Statut==='ClÃ´turÃ©'?'done':''}">
<div class="di-header"><div><div class="di-id">${di.ID}</div></div><span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut}</span></div>
</div>
<div style="margin-top:16px">
<p><strong>ğŸ“… Date:</strong> ${di.Date||'-'} ${di.Heure||''}</p>
<p><strong>ğŸ“ Ligne:</strong> ${di.Ligne||'-'}</p>
<p><strong>âš™ï¸ Machine:</strong> ${di.Machine||'-'}</p>
<p><strong>ğŸ”§ Zone:</strong> ${di.Zone||'-'}</p>
<p><strong>ğŸ”© Composant:</strong> ${di.Composant||'-'}</p>
<p><strong>âš ï¸ Anomalie:</strong> ${di.Anomalie||'-'}</p>
${di.Description?`<p><strong>ğŸ“ Description:</strong> ${di.Description}</p>`:''}
${di.Duree?`<p><strong>â±ï¸ DurÃ©e arrÃªt:</strong> ${di.Duree} min</p>`:''}
${di.Commentaire?`<p><strong>ğŸ’¬ Commentaire:</strong> ${di.Commentaire}</p>`:''}
</div>
<div style="margin-top:12px;padding:12px;background:#fee2e2;border-radius:12px">
<div style="font-weight:700;color:var(--danger);margin-bottom:6px">ğŸš¨ SignalÃ© par</div>
<p style="margin:0"><strong>${di.Operateur||'-'}</strong></p>
${di.Techniciens?`<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Techniciens demandÃ©s: ${di.Techniciens}</p>`:''}
</div>
${btAssocie?`
<div style="margin-top:12px;padding:12px;background:#dbeafe;border-radius:12px">
<div style="font-weight:700;color:var(--primary);margin-bottom:6px">ğŸ”§ TraitÃ© par</div>
<p style="margin:0"><strong>${btAssocie.Technicien||'-'}</strong></p>
<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Cause: ${btAssocie.Cause||'-'}</p>
<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Action: ${btAssocie.Action_Type||'-'}</p>
</div>
${btAssocie.Statut==='ValidÃ©'?`
<div style="margin-top:12px;padding:12px;background:#d1fae5;border-radius:12px">
<div style="font-weight:700;color:var(--success);margin-bottom:6px">âœ”ï¸ ValidÃ© par</div>
<p style="margin:0"><strong>${validateur}</strong></p>
</div>`:''}
<p style="margin-top:12px"><strong>ğŸ“„ BT associÃ©:</strong> <span style="color:var(--warning);font-weight:700">${di.BT_ID}</span></p>
<button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="openBTDetail('${di.BT_ID}');closeModal('modalDI')">ğŸ“„ Voir le BT complet</button>
`:'<p style="margin-top:12px;color:var(--gray-500);font-style:italic">â³ En attente de traitement...</p>'}
`;
openModal('modalDI');}

async function confirmDeleteDI(diId){if(!confirm('Supprimer cette DI?'))return;const result=await api('deleteDI',{diId});if(result.success){toast('âœ… DI supprimÃ©e');await loadAllData();renderMyDIs();}else toast('âŒ '+(result.error||'Erreur'));}

function openTraitement(diId){
currentDI=allDI.find(di=>di.ID===diId);if(!currentDI)return;
document.getElementById('modalDIInfo').innerHTML=`<div class="di-header"><div><div class="di-id">${currentDI.ID}</div><div class="di-date">${currentDI.Date||''}</div></div></div><div class="di-machine">âš™ï¸ ${currentDI.Machine}</div><div class="di-info">ğŸ“ ${currentDI.Ligne} | ğŸ”§ ${currentDI.Zone} | ğŸ”© ${currentDI.Composant}</div><div class="di-info">âš ï¸ ${currentDI.Anomalie}</div>${currentDI.Description?`<div class="di-info">ğŸ“ ${currentDI.Description}</div>`:''}`;
document.getElementById('traitCause').value='';document.getElementById('traitDiag').value='';document.getElementById('traitAction').value='';document.getElementById('traitDetail').value='';
openModal('modalTraitement');}

async function closeDI(){
if(!currentDI)return;
const cause=document.getElementById('traitCause').value,diagnostic=document.getElementById('traitDiag').value,actionType=document.getElementById('traitAction').value,actionDetail=document.getElementById('traitDetail').value,pieces=document.getElementById('traitPieces').value;
if(!cause||!diagnostic||!actionType||!actionDetail){toast('âš ï¸ Remplir tous les champs obligatoires');return;}
const btn=document.getElementById('btnCloseDI');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>';
const result=await api('cloturerDI',{diId:currentDI.ID,technicien:user.nom,cause,diagnostic,actionType,actionDetail,pieces:pieces,userId:user.id});
if(result.success){toast('âœ… BT gÃ©nÃ©rÃ©: '+result.btId);closeModal('modalTraitement');await loadAllData();}
else toast('âŒ '+(result.error||'Erreur'));
btn.disabled=false;btn.innerHTML='âœ… ClÃ´turer et GÃ©nÃ©rer BT';}

function getStatutClass(s){switch(s){case'En cours':return'en-cours';case'En attente piÃ¨ces':return'attente';case'TerminÃ©':return'termine';case'ValidÃ©':return'valide';default:return'en-cours';}}

function renderBTList(filter=''){
let bts=allBT;if(filter){const f=filter.toLowerCase();bts=bts.filter(bt=>(bt.BT_ID||'').toLowerCase().includes(f)||(bt.Machine||'').toLowerCase().includes(f));}
if(!bts.length){document.getElementById('btList').innerHTML='<div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun BT</div>';return;}
document.getElementById('btList').innerHTML=bts.map(bt=>{const statut=bt.Statut||'En cours';return`<div class="bt-card" onclick="openBTDetail('${bt.BT_ID}')"><div class="bt-header"><div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">RÃ©f: ${bt.Anomalie_ID||'-'}</div></div><span class="bt-statut ${getStatutClass(statut)}">${statut}</span></div><div class="bt-grid"><div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div><div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${bt.Technicien||'-'}</div></div></div></div>`;}).join('');}

function renderHistoriqueBT(){
const search=(document.getElementById('searchHistBT').value||'').toLowerCase();
let bts=allBT;if(search)bts=bts.filter(b=>(b.BT_ID||'').toLowerCase().includes(search)||(b.Machine||'').toLowerCase().includes(search));
if(!bts.length){document.getElementById('histBTList').innerHTML='<div class="list-empty"><div class="empty-icon">ğŸ“­</div>Aucun BT</div>';return;}
document.getElementById('histBTList').innerHTML=bts.map(bt=>{const statut=bt.Statut||'En cours';return`<div class="bt-card" onclick="openBTDetail('${bt.BT_ID}')"><div class="bt-header"><div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">${bt.Date||''}</div></div><span class="bt-statut ${getStatutClass(statut)}">${statut}</span></div><div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div></div>`;}).join('');}

function renderBTToValidate(){
const bts=allBT.filter(b=>b.Statut==='TerminÃ©');
if(!bts.length){document.getElementById('btToValidateList').innerHTML='<div class="list-empty"><div class="empty-icon">âœ…</div>Aucun BT Ã  valider</div>';return;}
document.getElementById('btToValidateList').innerHTML=bts.map(bt=>`<div class="bt-card" onclick="openChangeStatut('${bt.BT_ID}')"><div class="bt-header"><div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">RÃ©f: ${bt.Anomalie_ID||'-'}</div></div><span class="bt-statut termine">TerminÃ©</span></div><div class="bt-grid"><div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div><div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${bt.Technicien||'-'}</div></div></div><div class="di-actions"><button class="di-btn success">âœ”ï¸ Valider</button></div></div>`).join('');}

function openBTDetail(btId){
currentBT=allBT.find(b=>b.BT_ID===btId);if(!currentBT)return;
const statut=currentBT.Statut||'En cours';
// Trouver la DI associÃ©e pour avoir l'opÃ©rateur
const diAssociee=allDI.find(d=>d.ID===currentBT.Anomalie_ID);
// Parser l'historique des statuts
let historiqueHTML='';
try{
const hist=JSON.parse(currentBT.Historique||'[]');
if(hist.length){
historiqueHTML='<div style="margin-top:16px;padding:12px;background:var(--gray-50);border-radius:12px"><div style="font-weight:700;margin-bottom:10px">ğŸ“œ Historique des actions</div>';
hist.forEach(h=>{
historiqueHTML+=`<div style="padding:8px 0;border-bottom:1px solid var(--gray-200);font-size:13px"><span style="color:var(--primary);font-weight:600">${h.statut}</span> par <strong>${h.user||'-'}</strong><br><span style="color:var(--gray-400)">${h.date||''}</span>${h.comment?` - ${h.comment}`:''}</div>`;
});
historiqueHTML+='</div>';
}}catch(e){}
document.getElementById('modalBTContent').innerHTML=`
<div class="bt-card"><div class="bt-header"><div><div class="bt-id">${currentBT.BT_ID}</div><div class="bt-ref">RÃ©f: ${currentBT.Anomalie_ID||'-'}</div></div><span class="bt-statut ${getStatutClass(statut)}">${statut}</span></div></div>
<div style="margin-top:16px">
<p><strong>ğŸ“… Date:</strong> ${currentBT.Date||'-'}</p>
<p><strong>âš™ï¸ Machine:</strong> ${currentBT.Machine||'-'}</p>
<p><strong>ğŸ“ Ligne:</strong> ${currentBT.Ligne||'-'}</p>
<p><strong>âš ï¸ Anomalie:</strong> ${currentBT.Anomalie||'-'}</p>
</div>
<div style="margin-top:12px;padding:12px;background:#fee2e2;border-radius:12px">
<div style="font-weight:700;color:var(--danger);margin-bottom:6px">ğŸš¨ SignalÃ© par</div>
<p style="margin:0"><strong>${diAssociee?.Operateur||'-'}</strong></p>
</div>
<div style="margin-top:12px;padding:12px;background:#dbeafe;border-radius:12px">
<div style="font-weight:700;color:var(--primary);margin-bottom:6px">ğŸ”§ TraitÃ© par</div>
<p style="margin:0"><strong>${currentBT.Technicien||'-'}</strong></p>
<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Cause: ${currentBT.Cause||'-'}</p>
<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Diagnostic: ${currentBT.Diagnostic||'-'}</p>
<p style="margin:4px 0 0 0;font-size:13px;color:var(--gray-600)">Action: ${currentBT.Action_Type||'-'} - ${currentBT.Action_Detail||'-'}</p>
</div>
${statut==='ValidÃ©'?`<div style="margin-top:12px;padding:12px;background:#d1fae5;border-radius:12px">
<div style="font-weight:700;color:var(--success);margin-bottom:6px">âœ”ï¸ ValidÃ© par</div>
<p style="margin:0"><strong>${getValidateur(currentBT.Historique)}</strong></p>
</div>`:''}
${historiqueHTML}
<button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="openChangeStatut('${currentBT.BT_ID}');closeModal('modalBT')">ğŸ“Š Changer statut</button>`;
openModal('modalBT');}

function getValidateur(histJson){
try{const hist=JSON.parse(histJson||'[]');const valid=hist.find(h=>h.statut==='ValidÃ©');return valid?.user||'-';}catch(e){return '-';}}


function openChangeStatut(btId){
currentBT=allBT.find(b=>b.BT_ID===btId);if(!currentBT)return;
const statut=currentBT.Statut||'En cours',role=(user.role||'').toLowerCase();
const canValidate=(role==='chef_equipe'||role==='chef equipe');
document.getElementById('modalStatutBTInfo').innerHTML=`<div class="bt-header"><div><div class="bt-id">${currentBT.BT_ID}</div><div class="bt-ref">RÃ©f: ${currentBT.Anomalie_ID||'-'}</div></div><span class="bt-statut ${getStatutClass(statut)}">${statut}</span></div><div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${currentBT.Machine||'-'}</div></div>`;
const statuts=[{value:'En cours',label:'ğŸ”§ En cours'},{value:'En attente piÃ¨ces',label:'ğŸ“¦ En attente piÃ¨ces'},{value:'TerminÃ©',label:'âœ… TerminÃ©'}];
if(canValidate)statuts.push({value:'ValidÃ©',label:'âœ”ï¸ ValidÃ© (Chef Ã©quipe)'});
const select=document.getElementById('selectNewStatut');
select.innerHTML=statuts.map(s=>`<option value="${s.value}" ${s.value===statut?'selected':''}>${s.label}</option>`).join('');
document.getElementById('validationInfo').style.display=canValidate?'none':'block';
document.getElementById('statutComment').value='';
document.querySelectorAll('#modalStatutBT .statut-step').forEach(step=>{step.classList.remove('active','completed');const stepStatut=step.dataset.statut;const order={'En cours':1,'En attente piÃ¨ces':2,'TerminÃ©':3,'ValidÃ©':4};if(stepStatut===statut)step.classList.add('active');else if(order[stepStatut]<order[statut])step.classList.add('completed');});
openModal('modalStatutBT');}

async function saveNewStatut(){
if(!currentBT)return;
const newStatut=document.getElementById('selectNewStatut').value,comment=document.getElementById('statutComment').value.trim(),oldStatut=currentBT.Statut||'En cours',role=(user.role||'').toLowerCase();
if(newStatut===oldStatut){toast('âš ï¸ MÃªme statut');return;}
if(newStatut==='ValidÃ©'&&role!=='chef_equipe'&&role!=='chef equipe'){toast('âŒ Seul le Chef d\'Ã©quipe peut valider');return;}
// VÃ©rifier horaires si statut TerminÃ©
let heureArrivee='',heureFin='';
if(newStatut==='TerminÃ©'){
heureArrivee=document.getElementById('btHeureArrivee').value;
heureFin=document.getElementById('btHeureFin').value;
if(!heureArrivee||!heureFin){toast('âš ï¸ Remplir les horaires d\'intervention');return;}
}
// Heure validation auto pour chef Ã©quipe
let heureValidation='';
if(newStatut==='ValidÃ©'){heureValidation=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});}
const btn=document.getElementById('btnSaveStatut');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>';
const result=await api('updateBTStatut',{btId:currentBT.BT_ID,newStatut,comment,userName:user.nom,heureArrivee,heureFin,heureValidation});
if(result.success){toast('âœ… Statut mis Ã  jour');closeModal('modalStatutBT');await loadAllData();if(document.getElementById('pageValidation').classList.contains('active'))renderBTToValidate();}
else toast('âŒ '+(result.error||'Erreur'));
btn.disabled=false;btn.innerHTML='ğŸ’¾ Valider';}

function setCurrentTime(inputId){
const now=new Date();
const hh=String(now.getHours()).padStart(2,'0');
const mm=String(now.getMinutes()).padStart(2,'0');
document.getElementById(inputId).value=hh+':'+mm;}

function onStatutChange(){
const newStatut=document.getElementById('selectNewStatut').value;
const horairesDiv=document.getElementById('horairesIntervention');
if(newStatut==='TerminÃ©'){horairesDiv.style.display='block';}
else{horairesDiv.style.display='none';}}

let editingDI=null;
function openEditDI(diId){
editingDI=allDI.find(d=>d.ID===diId);
if(!editingDI||editingDI.Statut!=='En attente'){toast('âŒ DI non modifiable');return;}
// Remplir les selects
const lignes=[...new Set((db.machines||[]).map(m=>m.Ligne).filter(Boolean))];
document.getElementById('editDILigne').innerHTML=lignes.map(l=>`<option value="${l}" ${l===editingDI.Ligne?'selected':''}>${l}</option>`).join('');
populateEditMachines();
document.getElementById('editDILigne').onchange=populateEditMachines;
document.getElementById('editDIMachine').onchange=populateEditZones;
document.getElementById('editDIZone').onchange=populateEditComposants;
document.getElementById('editDIAnomalie').innerHTML=(db.anomalies||[]).map(a=>`<option value="${a.Anomalie}" ${a.Anomalie===editingDI.Anomalie?'selected':''}>${a.Anomalie}</option>`).join('');
document.getElementById('editDIComment').value=editingDI.Commentaire||'';
openModal('modalEditDI');}

function populateEditMachines(){
const ligne=document.getElementById('editDILigne').value;
const machines=(db.machines||[]).filter(m=>m.Ligne===ligne);
document.getElementById('editDIMachine').innerHTML=machines.map(m=>`<option value="${m.Machine}" ${m.Machine===editingDI?.Machine?'selected':''}>${m.Machine}</option>`).join('');
populateEditZones();}

function populateEditZones(){
const machine=document.getElementById('editDIMachine').value;
const zones=(db.zones||[]).filter(z=>z.Machine===machine);
document.getElementById('editDIZone').innerHTML=zones.map(z=>`<option value="${z.Zone}" ${z.Zone===editingDI?.Zone?'selected':''}>${z.Zone}</option>`).join('');
populateEditComposants();}

function populateEditComposants(){
const zone=document.getElementById('editDIZone').value;
const composants=(db.composants||[]).filter(c=>c.Zone===zone);
document.getElementById('editDIComposant').innerHTML=composants.map(c=>`<option value="${c.Composant}" ${c.Composant===editingDI?.Composant?'selected':''}>${c.Composant}</option>`).join('');}

async function saveEditDI(){
if(!editingDI)return;
const data={diId:editingDI.ID,ligne:document.getElementById('editDILigne').value,machine:document.getElementById('editDIMachine').value,zone:document.getElementById('editDIZone').value,composant:document.getElementById('editDIComposant').value,anomalie:document.getElementById('editDIAnomalie').value,commentaire:document.getElementById('editDIComment').value};
const result=await api('updateDI',data);
if(result.success){toast('âœ… DI modifiÃ©e');closeModal('modalEditDI');await loadAllData();}
else toast('âŒ '+(result.error||'Erreur'));}

function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
</script>
</body>
</html>
