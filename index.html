<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="GMAO BAHIA - Gestion Maintenance">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>GMAO BAHIA v8.3</title>
    <style>
:root{--primary:#1e40af;--primary-light:#3b82f6;--secondary:#f59e0b;--success:#10b981;--danger:#ef4444;--purple:#8b5cf6;--gray-50:#f8fafc;--gray-100:#f1f5f9;--gray-200:#e2e8f0;--gray-300:#cbd5e1;--gray-400:#94a3b8;--gray-500:#64748b;--gray-600:#475569;--gray-700:#334155;--gray-800:#1e293b}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--gray-100);min-height:100vh;color:var(--gray-800)}
.hidden{display:none!important}
.login-page{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(135deg,var(--primary),var(--primary-light))}
.login-header{padding:60px 24px 40px;text-align:center;color:#fff}
.login-logo{font-size:64px;margin-bottom:16px}
.login-header h1{font-size:28px;font-weight:800}
.login-header p{opacity:.9;font-size:14px;margin-top:8px}
.login-card{flex:1;background:#fff;border-radius:32px 32px 0 0;padding:32px 24px}
.login-card h2{font-size:22px;margin-bottom:24px;text-align:center}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:14px;font-weight:600;color:var(--gray-600);margin-bottom:8px}
.input-box{position:relative}
.input-box .icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:20px}
.input-box input{width:100%;padding:16px 16px 16px 52px;border:2px solid var(--gray-200);border-radius:14px;font-size:16px;background:var(--gray-50)}
.input-box input:focus{outline:none;border-color:var(--primary);background:#fff}
.checkbox-group{display:flex;align-items:center;gap:10px;margin-bottom:24px}
.checkbox-group input{width:20px;height:20px;accent-color:var(--primary)}
.btn-login{width:100%;padding:18px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer}
.btn-login:disabled{background:var(--gray-400)}
.login-error{background:#fef2f2;border:1px solid #fecaca;color:var(--danger);padding:14px;border-radius:12px;margin-bottom:20px;font-size:14px;display:none}
.app{display:none;min-height:100vh;padding-bottom:100px}
.app.active{display:block}
.header{background:#fff;padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.header-top{display:flex;justify-content:space-between;align-items:center}
.header-user{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
.user-info h1{font-size:16px;font-weight:700}
.user-info .role{font-size:13px;color:var(--gray-500)}
.header-actions{display:flex;gap:8px}
.header-btn{width:44px;height:44px;border-radius:12px;background:var(--gray-100);border:none;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.header-btn.danger{background:#fef2f2;color:var(--danger)}
.status-bar{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;padding:8px 16px;background:var(--gray-50);border-radius:10px;font-size:13px;color:var(--gray-600)}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
.status-dot.online{background:var(--success)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:8px 12px 24px;display:flex;justify-content:space-around;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:1000}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 16px;border-radius:14px;background:none;border:none;color:var(--gray-400);font-size:12px;font-weight:600;cursor:pointer;position:relative}
.nav-btn .nav-icon{font-size:24px}
.nav-btn.active{color:var(--primary);background:#eff6ff}
.nav-badge{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;font-size:11px;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-weight:700}
.page{display:none;padding:20px;padding-bottom:120px}
.page.active{display:block}
.page-title{font-size:22px;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.tabs{display:flex;background:var(--gray-100);border-radius:16px;padding:5px;margin-bottom:20px}
.tab-btn{flex:1;padding:14px 12px;border:none;background:none;font-size:14px;font-weight:600;color:var(--gray-500);cursor:pointer;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
.tab-btn.active{background:#fff;color:var(--primary);box-shadow:0 2px 10px rgba(0,0,0,.08)}
.tab-btn .tab-icon{font-size:20px}
.tab-badge{background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:10px}
.tab-content{display:none}
.tab-content.active{display:block}
.card{background:#fff;border-radius:18px;padding:18px;margin-bottom:14px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.card-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.card-icon.blue{background:#dbeafe}
.card-icon.orange{background:#fef3c7}
.card-icon.green{background:#d1fae5}
.card-icon.red{background:#fee2e2}
.card-icon.purple{background:#ede9fe}
.card-title{font-size:16px;font-weight:700}
.card-subtitle{font-size:13px;color:var(--gray-500)}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 4px 15px rgba(0,0,0,.06)}
.stat-value{font-size:32px;font-weight:800;color:var(--primary)}
.stat-label{font-size:13px;color:var(--gray-500);margin-top:4px}
.stat-card.warning .stat-value{color:var(--secondary)}
.stat-card.success .stat-value{color:var(--success)}
.stat-card.danger .stat-value{color:var(--danger)}
.form-label{font-size:14px;font-weight:600;color:var(--gray-600);margin-bottom:8px;display:block}
.form-select,.form-input,.form-textarea{width:100%;padding:14px 16px;border:2px solid var(--gray-200);border-radius:12px;font-size:16px;background:var(--gray-50);color:var(--gray-800)}
.form-select:focus,.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--primary);background:#fff}
.form-textarea{resize:none;min-height:100px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{padding:12px 18px;background:#e0e7ff;border:2px solid #818cf8;border-radius:30px;font-size:15px;font-weight:600;color:#3730a3;cursor:pointer}
.chip.selected{background:var(--primary);border-color:var(--primary);color:#fff}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.tech-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#f0f9ff;border:2px solid #7dd3fc;border-radius:12px;cursor:pointer}
.tech-item.selected{border-color:var(--primary);background:#eff6ff}
.tech-item input{width:20px;height:20px;accent-color:var(--primary)}
.tech-name{font-size:14px;font-weight:600;flex:1}
.timer-card{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;border-radius:18px;padding:24px;text-align:center;margin-bottom:16px}
.timer-label{font-size:14px;opacity:.9;margin-bottom:10px}
.timer-display{font-size:48px;font-weight:800;font-family:'Courier New',monospace;letter-spacing:3px}
.timer-buttons{display:flex;justify-content:center;gap:12px;margin-top:16px}
.timer-btn{padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px}
.timer-btn.start{background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.4)}
.timer-btn.reset{background:rgba(0,0,0,.2);color:#fff}
.di-card{background:#fff;border-radius:18px;padding:18px;margin-bottom:14px;box-shadow:0 4px 15px rgba(0,0,0,.06);border-left:5px solid var(--danger)}
.di-card.done{border-left-color:var(--success)}
.di-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.di-id{font-size:17px;font-weight:700;color:var(--danger)}
.di-card.done .di-id{color:var(--success)}
.di-date{font-size:12px;color:var(--gray-400)}
.di-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
.di-badge.waiting{background:#fef3c7;color:#b45309}
.di-badge.done{background:#d1fae5;color:#059669}
.di-machine{font-size:16px;font-weight:600;margin-bottom:6px}
.di-info{font-size:14px;color:var(--gray-600);margin-bottom:4px}
.di-actions{display:flex;gap:10px;margin-top:14px}
.di-btn{flex:1;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.di-btn.primary{background:var(--primary);color:#fff}
.di-btn.success{background:var(--success);color:#fff}
.bt-card{background:linear-gradient(135deg,var(--secondary),#d97706);color:#fff;border-radius:18px;padding:18px;margin-bottom:14px;cursor:pointer}
.bt-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.bt-id{font-size:19px;font-weight:800}
.bt-ref{font-size:13px;opacity:.8}
.bt-section{background:rgba(255,255,255,.15);border-radius:12px;padding:12px;margin-bottom:10px}
.bt-section-title{font-size:12px;opacity:.7;text-transform:uppercase;margin-bottom:4px}
.bt-section-value{font-weight:600;font-size:15px}
.bt-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.list-container{background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.06)}
.list-empty{padding:50px 24px;text-align:center;color:var(--gray-400)}
.list-empty .empty-icon{font-size:56px;margin-bottom:14px}
.list-item{padding:16px;border-bottom:1px solid var(--gray-100)}
.list-item:last-child{border-bottom:none}
.search-box{position:relative;margin-bottom:16px}
.search-box .search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:20px;color:var(--gray-400)}
.search-box input{width:100%;padding:16px 16px 16px 52px;border:2px solid var(--gray-200);border-radius:14px;font-size:16px;background:#fff}
.search-box input:focus{outline:none;border-color:var(--primary)}
.piece-item{display:flex;align-items:center;gap:14px;padding:16px;border-bottom:1px solid var(--gray-100)}
.piece-item:last-child{border-bottom:none}
.piece-check{width:22px;height:22px;accent-color:var(--primary)}
.piece-info{flex:1}
.piece-code{font-weight:700;font-size:15px;color:var(--primary)}
.piece-name{font-size:14px;color:var(--gray-600)}
.piece-stock{font-size:13px;color:var(--gray-400)}
.stock-low{background:#fef2f2;color:var(--danger);padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600}
.user-badge{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:14px 18px;border-radius:14px;display:flex;align-items:center;gap:12px}
.user-badge .badge-icon{font-size:28px}
.user-badge .badge-name{font-weight:700;font-size:16px}
.user-badge .badge-role{font-size:13px;opacity:.9}
.preview-box{background:var(--gray-800);color:#fff;padding:16px;border-radius:14px;font-family:'Courier New',monospace;font-size:13px;white-space:pre-wrap;line-height:1.6}
.success-box{text-align:center;padding:40px 24px;background:#d1fae5;border-radius:18px;margin-bottom:16px}
.success-icon{font-size:60px;margin-bottom:14px}
.success-box h3{color:var(--success);font-size:20px;margin-bottom:8px}
.success-box p{color:var(--gray-600);font-size:14px}
.success-id{font-size:18px;font-weight:700;color:var(--gray-800);margin-top:14px;font-family:'Courier New',monospace}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:flex-end;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s}
.modal.show{opacity:1;pointer-events:auto}
.modal-content{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:24px;transform:translateY(100%);transition:transform .3s}
.modal.show .modal-content{transform:translateY(0)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h3{font-size:20px;font-weight:700}
.modal-close{width:40px;height:40px;border-radius:50%;background:var(--gray-100);border:none;font-size:22px;cursor:pointer}
.action-bar{position:fixed;bottom:100px;left:0;right:0;padding:16px 20px;background:linear-gradient(transparent,var(--gray-100) 30%);z-index:500;display:none}
.action-bar.show{display:block}
.action-buttons{display:flex;gap:12px}
.btn{flex:1;padding:16px;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
.btn:disabled{background:var(--gray-400)!important;cursor:not-allowed}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-whatsapp{width:60px;flex:none;background:#25d366;color:#fff;border-radius:16px}
.btn-whatsapp svg{width:28px;height:28px;fill:#fff}
.toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--gray-800);color:#fff;padding:14px 28px;border-radius:30px;font-size:15px;font-weight:600;z-index:3000;opacity:0;transition:all .3s}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.print-area{display:none}
@media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%;padding:20px;display:block}}
/* v8.3 - Filtres */
.filter-bar{display:flex;gap:10px;margin-bottom:16px}
.filter-select{flex:1;padding:12px 16px;border:2px solid var(--gray-200);border-radius:12px;font-size:14px;background:#fff;color:var(--gray-700)}
.filter-btn{padding:12px 16px;background:var(--success);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer}
/* v8.3 - KPIs avanc√©s */
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px}
.kpi-card{background:#fff;border-radius:16px;padding:16px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.kpi-icon{font-size:32px;width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:var(--gray-100);border-radius:12px}
.kpi-content{flex:1}
.kpi-value{font-size:20px;font-weight:800;color:var(--gray-800)}
.kpi-label{font-size:13px;font-weight:600;color:var(--gray-600)}
.kpi-desc{font-size:11px;color:var(--gray-400)}
/* v8.3 - Photo upload */
.photo-upload{text-align:center}
.photo-btn{width:100%;padding:20px;border:2px dashed var(--gray-300);border-radius:14px;background:var(--gray-50);color:var(--gray-600);font-size:16px;cursor:pointer}
.photo-btn:hover{border-color:var(--primary);color:var(--primary)}
.photo-preview{position:relative;margin-top:12px;display:inline-block}
.photo-preview img{max-width:100%;max-height:200px;border-radius:12px;border:2px solid var(--gray-200)}
.photo-remove{position:absolute;top:-8px;right:-8px;width:28px;height:28px;background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:16px;cursor:pointer}
/* v8.3 - Date filter in historique */
.date-filter{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.date-input{flex:1;min-width:120px;padding:10px 14px;border:2px solid var(--gray-200);border-radius:10px;font-size:14px}
/* v8.3 - Statut BT workflow */
.statut-workflow{background:var(--gray-50);border-radius:14px;padding:16px;margin-bottom:20px}
.statut-title{font-size:13px;color:var(--gray-500);margin-bottom:12px;text-transform:uppercase;font-weight:600}
.statut-steps{display:flex;align-items:center;flex-wrap:wrap;gap:8px;justify-content:center}
.statut-step{background:#fff;border:2px solid var(--gray-200);border-radius:10px;padding:10px 14px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;cursor:pointer;transition:all .2s}
.statut-step:hover{border-color:var(--primary);background:var(--gray-100)}
.statut-step.active{border-color:var(--primary);background:var(--primary);color:#fff}
.statut-step.completed{border-color:var(--success);background:#d1fae5;color:var(--success)}
.statut-arrow{color:var(--gray-400);font-size:16px}
.statut-icon{font-size:16px}
/* v8.3 - BT statut badges */
.bt-statut{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600}
.bt-statut.en-cours{background:#dbeafe;color:#1e40af}
.bt-statut.attente-pieces{background:#fef3c7;color:#92400e}
.bt-statut.termine{background:#d1fae5;color:#065f46}
.bt-statut.valide{background:#ede9fe;color:#5b21b6}
    </style>
</head>
<body>
<!-- LOGIN -->
<div class="login-page" id="loginPage">
    <div class="login-header">
        <div class="login-logo">üè≠</div>
        <h1>GMAO BAHIA</h1>
        <p>Gestion Maintenance Assist√©e v8.0</p>
    </div>
    <div class="login-card">
        <h2>Connexion</h2>
        <div class="login-error" id="loginError"></div>
        <div class="form-group">
            <label>Identifiant</label>
            <div class="input-box"><span class="icon">üë§</span><input type="text" id="loginUser" placeholder="Votre identifiant"></div>
        </div>
        <div class="form-group">
            <label>Mot de passe</label>
            <div class="input-box"><span class="icon">üîí</span><input type="password" id="loginPass" placeholder="Votre mot de passe"></div>
        </div>
        <div class="checkbox-group"><input type="checkbox" id="rememberMe" checked><label for="rememberMe">Se souvenir de moi</label></div>
        <button class="btn-login" id="btnLogin">üöÄ Connexion</button>
    </div>
</div>

<!-- APP -->
<div class="app" id="mainApp">
    <header class="header">
        <div class="header-top">
            <div class="header-user">
                <div class="avatar" id="userAvatar">A</div>
                <div class="user-info"><h1 id="userName">Utilisateur</h1><div class="role" id="userRole">Op√©rateur</div></div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="btnRefresh" title="Actualiser">üîÑ</button>
                <button class="header-btn danger" id="btnLogout" title="D√©connexion">üö™</button>
            </div>
        </div>
        <div class="status-bar"><div class="status-dot" id="statusDot"></div><span id="statusText">Connexion...</span></div>
    </header>

    <!-- PAGE ACCUEIL -->
    <div class="page active" id="pageHome">
        <h2 class="page-title">üìä Tableau de bord</h2>
        
        <!-- Filtres par p√©riode -->
        <div class="filter-bar">
            <select class="filter-select" id="filterPeriod">
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month" selected>Ce mois</option>
                <option value="year">Cette ann√©e</option>
                <option value="all">Tout</option>
            </select>
            <button class="filter-btn" id="btnExportExcel">üìä Export</button>
        </div>
        
        <!-- KPIs principaux -->
        <div class="stats-grid">
            <div class="stat-card danger"><div class="stat-value" id="statDI">0</div><div class="stat-label">DI en attente</div></div>
            <div class="stat-card warning"><div class="stat-value" id="statBT">0</div><div class="stat-label">BT p√©riode</div></div>
            <div class="stat-card success"><div class="stat-value" id="statResolved">0</div><div class="stat-label">R√©solus</div></div>
            <div class="stat-card"><div class="stat-value" id="statStock">0</div><div class="stat-label">Stock critique</div></div>
        </div>
        
        <!-- KPIs avanc√©s -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">‚è±Ô∏è</div>
                <div class="kpi-content">
                    <div class="kpi-value" id="kpiMTTR">--</div>
                    <div class="kpi-label">MTTR (moy.)</div>
                    <div class="kpi-desc">Temps moyen r√©paration</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üîÑ</div>
                <div class="kpi-content">
                    <div class="kpi-value" id="kpiTauxPanne">--%</div>
                    <div class="kpi-label">Taux pannes</div>
                    <div class="kpi-desc">DI / machines</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">‚ö†Ô∏è</div>
                <div class="kpi-content">
                    <div class="kpi-value" id="kpiRetard">0</div>
                    <div class="kpi-label">DI en retard</div>
                    <div class="kpi-desc">> 24h sans traitement</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üèÜ</div>
                <div class="kpi-content">
                    <div class="kpi-value" id="kpiTopMachine">--</div>
                    <div class="kpi-label">Machine critique</div>
                    <div class="kpi-desc">Plus de pannes</div>
                </div>
            </div>
        </div>
        
        <!-- Activit√© r√©cente -->
        <div class="card">
            <div class="card-header"><div class="card-icon orange">üìã</div><div><div class="card-title">Activit√© r√©cente</div><div class="card-subtitle">Derni√®res interventions</div></div></div>
            <div id="recentActivity"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune activit√©</div></div></div>
        </div>
    </div>

    <!-- PAGE SIGNALEMENT -->
    <div class="page" id="pageSignal">
        <h2 class="page-title">üö® Signalement</h2>
        <div class="tabs">
            <button class="tab-btn active" data-tab="new"><span class="tab-icon">‚ûï</span>Nouveau</button>
            <button class="tab-btn" data-tab="history"><span class="tab-icon">üìú</span>Historique<span class="tab-badge" id="myDICount">0</span></button>
        </div>
        <div class="tab-content active" id="tabSignalNew">
            <div class="timer-card">
                <div class="timer-label">‚è±Ô∏è Temps d'arr√™t</div>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="timer-buttons">
                    <button class="timer-btn start" id="timerStartBtn">‚ñ∂Ô∏è D√©marrer</button>
                    <button class="timer-btn reset" id="timerResetBtn">üîÑ Reset</button>
                </div>
            </div>
            <div class="card" id="step1"><div class="card-header"><div class="card-icon blue">1Ô∏è‚É£</div><div class="card-title">Op√©rateur</div></div><div class="user-badge" id="operatorBadge"><span class="badge-icon">üë§</span><div><div class="badge-name">-</div><div class="badge-role">Op√©rateur</div></div></div></div>
            <div class="card" id="step2"><div class="card-header"><div class="card-icon blue">2Ô∏è‚É£</div><div class="card-title">Ligne</div></div><div class="chips" id="lignesChips"></div></div>
            <div class="card hidden" id="step3"><div class="card-header"><div class="card-icon blue">3Ô∏è‚É£</div><div class="card-title">Machine</div></div><div class="chips" id="machinesChips"></div></div>
            <div class="card hidden" id="step4"><div class="card-header"><div class="card-icon blue">4Ô∏è‚É£</div><div class="card-title">Zone</div></div><div class="chips" id="zonesChips"></div></div>
            <div class="card hidden" id="step5"><div class="card-header"><div class="card-icon blue">5Ô∏è‚É£</div><div class="card-title">Composant</div></div><div class="chips" id="composantsChips"></div></div>
            <div class="card hidden" id="step6"><div class="card-header"><div class="card-icon red">6Ô∏è‚É£</div><div class="card-title">Anomalie</div></div><div class="chips" id="anomaliesChips"></div></div>
            <div class="card hidden" id="step7"><div class="card-header"><div class="card-icon purple">7Ô∏è‚É£</div><div class="card-title">Techniciens</div></div><div class="tech-grid" id="techsGrid"></div></div>
            <div class="card hidden" id="step8"><div class="card-header"><div class="card-icon green">8Ô∏è‚É£</div><div class="card-title">Commentaire</div></div><textarea class="form-textarea" id="commentInput" placeholder="Description..."></textarea></div>
            <div class="card hidden" id="step9">
                <div class="card-header"><div class="card-icon orange">9Ô∏è‚É£</div><div class="card-title">Photo (optionnel)</div></div>
                <div class="photo-upload">
                    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
                    <button class="photo-btn" id="btnTakePhoto">üì∑ Prendre une photo</button>
                    <div class="photo-preview hidden" id="photoPreview">
                        <img id="photoImg" src="" alt="Photo">
                        <button class="photo-remove" id="btnRemovePhoto">‚úï</button>
                    </div>
                </div>
            </div>
            <div class="card hidden" id="previewCard"><div class="card-header"><div class="card-icon orange">üëÅÔ∏è</div><div class="card-title">Aper√ßu</div></div><div class="preview-box" id="previewBox"></div></div>
            <div class="success-box hidden" id="successBox"><div class="success-icon">‚úÖ</div><h3>DI Enregistr√©e !</h3><p>En attente de traitement</p><div class="success-id" id="successId">DI-XXXXXXXX</div></div>
        </div>
        <div class="tab-content" id="tabSignalHistory"><div class="list-container" id="myDIList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun signalement</div></div></div></div>
    </div>

    <!-- PAGE MAINTENANCE -->
    <div class="page" id="pageMaint">
        <h2 class="page-title">üîß Maintenance</h2>
        <div class="tabs">
            <button class="tab-btn active" data-tab="di"><span class="tab-icon">üìã</span>DI √† traiter<span class="tab-badge" id="diWaitingCount">0</span></button>
            <button class="tab-btn" data-tab="bt"><span class="tab-icon">üìÑ</span>Historique BT</button>
        </div>
        <div class="tab-content active" id="tabMaintDI"><div id="diWaitingList"><div class="list-empty"><div class="empty-icon">‚úÖ</div><div>Aucune DI en attente</div></div></div></div>
        <div class="tab-content" id="tabMaintBT">
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchBT" placeholder="Rechercher BT..."></div>
            <div id="btList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun BT</div></div></div>
        </div>
    </div>

    <!-- PAGE HISTORIQUE (Lecture seule pour tous) -->
    <div class="page" id="pageHistorique">
        <h2 class="page-title">üìã Historique</h2>
        <div class="tabs">
            <button class="tab-btn active" data-tab="histDI"><span class="tab-icon">üìù</span>DI</button>
            <button class="tab-btn" data-tab="histBT"><span class="tab-icon">üìÑ</span>BT</button>
        </div>
        <div class="tab-content active" id="tabHistDI">
            <!-- Filtres DI -->
            <div class="date-filter">
                <input type="date" class="date-input" id="histDIDateFrom" placeholder="Du">
                <input type="date" class="date-input" id="histDIDateTo" placeholder="Au">
            </div>
            <div class="filter-bar">
                <select class="filter-select" id="histDIUser">
                    <option value="">Tous les op√©rateurs</option>
                </select>
                <select class="filter-select" id="histDIStatus">
                    <option value="">Tous statuts</option>
                    <option value="En attente">En attente</option>
                    <option value="Cl√¥tur√©">Cl√¥tur√©</option>
                </select>
            </div>
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchHistDI" placeholder="Rechercher DI..."></div>
            <div class="list-container" id="histDIList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune DI</div></div></div>
        </div>
        <div class="tab-content" id="tabHistBT">
            <!-- Filtres BT -->
            <div class="date-filter">
                <input type="date" class="date-input" id="histBTDateFrom" placeholder="Du">
                <input type="date" class="date-input" id="histBTDateTo" placeholder="Au">
            </div>
            <div class="filter-bar">
                <select class="filter-select" id="histBTUser">
                    <option value="">Tous les techniciens</option>
                </select>
                <select class="filter-select" id="histBTMachine">
                    <option value="">Toutes machines</option>
                </select>
            </div>
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchHistBT" placeholder="Rechercher BT..."></div>
            <div class="list-container" id="histBTList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun BT</div></div></div>
        </div>
    </div>

    <!-- PAGE PDR -->
    <div class="page" id="pagePDR">
        <h2 class="page-title">üì¶ Pi√®ces de Rechange</h2>
        <div class="tabs">
            <button class="tab-btn active" data-tab="stock"><span class="tab-icon">üì¶</span>Stock</button>
            <button class="tab-btn" data-tab="sorties"><span class="tab-icon">üì§</span>Sorties</button>
        </div>
        <div class="tab-content active" id="tabPDRStock">
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchPiece" placeholder="Rechercher pi√®ce..."></div>
            <div class="list-container" id="piecesList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune pi√®ce</div></div></div>
        </div>
        <div class="tab-content" id="tabPDRSorties"><div class="list-container" id="sortiesList"><div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune sortie</div></div></div></div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-page="pageHome"><span class="nav-icon">üè†</span>Accueil</button>
        <button class="nav-btn" data-page="pageSignal"><span class="nav-icon">üö®</span>Signaler</button>
        <button class="nav-btn" data-page="pageMaint"><span class="nav-icon">üîß</span>Maintenance<span class="nav-badge" id="navDIBadge" style="display:none">0</span></button>
        <button class="nav-btn" data-page="pageHistorique"><span class="nav-icon">üìã</span>Historique</button>
        <button class="nav-btn" data-page="pagePDR"><span class="nav-icon">üì¶</span>PDR</button>
    </nav>

    <!-- ACTION BAR -->
    <div class="action-bar" id="signalActionBar">
        <div class="action-buttons">
            <button class="btn btn-primary" id="btnSaveDI" disabled>üíæ Enregistrer DI</button>
            <button class="btn btn-whatsapp" id="btnWhatsApp" disabled><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
        </div>
    </div>
</div>

<!-- MODAL TRAITEMENT -->
<div class="modal" id="modalTraitement">
    <div class="modal-content">
        <div class="modal-header"><h3>üîß Traiter la DI</h3><button class="modal-close" id="closeTraitement">‚úï</button></div>
        <div class="di-card" id="modalDIInfo"></div>
        <div class="form-group"><label class="form-label">Cause *</label><select class="form-select" id="traitCause"><option value="">-- S√©lectionner --</option><option value="Usure normale">Usure normale</option><option value="D√©faut mat√©riel">D√©faut mat√©riel</option><option value="Erreur op√©rateur">Erreur op√©rateur</option><option value="Manque maintenance">Manque maintenance</option><option value="Autre">Autre</option></select></div>
        <div class="form-group"><label class="form-label">Diagnostic *</label><textarea class="form-textarea" id="traitDiag" placeholder="Diagnostic..."></textarea></div>
        <div class="form-group"><label class="form-label">Type action *</label><select class="form-select" id="traitAction"><option value="">-- S√©lectionner --</option><option value="Correctif">Correctif</option><option value="Pr√©ventif">Pr√©ventif</option><option value="Am√©lioratif">Am√©lioratif</option></select></div>
        <div class="form-group"><label class="form-label">D√©tail *</label><textarea class="form-textarea" id="traitDetail" placeholder="Action r√©alis√©e..."></textarea></div>
        <div class="form-group"><label class="form-label">Pi√®ces utilis√©es</label><div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchPieceModal" placeholder="Rechercher..."></div><div class="list-container" style="max-height:200px;overflow-y:auto" id="modalPiecesList"></div><div id="selectedPiecesDisplay"></div></div>
        <button class="btn btn-success" style="width:100%;margin-top:16px" id="btnCloseDI">‚úÖ Cl√¥turer DI et G√©n√©rer BT</button>
    </div>
</div>

<!-- MODAL BT -->
<div class="modal" id="modalBT">
    <div class="modal-content">
        <div class="modal-header"><h3>üìÑ D√©tail BT</h3><button class="modal-close" id="closeBT">‚úï</button></div>
        <div id="modalBTContent"></div>
        <div class="action-buttons" style="margin-top:20px">
            <button class="btn btn-primary" id="btnPrintBT">üñ®Ô∏è Imprimer</button>
            <button class="btn btn-whatsapp" id="btnShareBT"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
        </div>
    </div>
</div>

<!-- v8.1: MODAL EDIT DI -->
<div class="modal" id="modalEditDI">
    <div class="modal-content">
        <div class="modal-header"><h3>‚úèÔ∏è Modifier la DI</h3><button class="modal-close" onclick="closeModal('modalEditDI')">‚úï</button></div>
        <div class="form-group"><label class="form-label">Ligne</label><select class="form-select" id="editDILigne"></select></div>
        <div class="form-group"><label class="form-label">Machine</label><select class="form-select" id="editDIMachine"></select></div>
        <div class="form-group"><label class="form-label">Zone</label><select class="form-select" id="editDIZone"></select></div>
        <div class="form-group"><label class="form-label">Composant</label><select class="form-select" id="editDIComposant"></select></div>
        <div class="form-group"><label class="form-label">Anomalie</label><select class="form-select" id="editDIAnomalie"></select></div>
        <div class="form-group"><label class="form-label">Commentaire</label><textarea class="form-textarea" id="editDIComment" placeholder="Description..."></textarea></div>
        <button class="btn btn-primary" style="width:100%;margin-top:16px" id="btnSaveEditDI">üíæ Sauvegarder</button>
    </div>
</div>

<!-- v8.1: MODAL EDIT BT -->
<div class="modal" id="modalEditBT">
    <div class="modal-content">
        <div class="modal-header"><h3>‚úèÔ∏è Modifier le BT</h3><button class="modal-close" onclick="closeModal('modalEditBT')">‚úï</button></div>
        <div class="form-group"><label class="form-label">Cause</label><select class="form-select" id="editBTCause"><option value="Usure normale">Usure normale</option><option value="D√©faut mat√©riel">D√©faut mat√©riel</option><option value="Erreur op√©rateur">Erreur op√©rateur</option><option value="Manque maintenance">Manque maintenance</option><option value="Autre">Autre</option></select></div>
        <div class="form-group"><label class="form-label">Diagnostic</label><textarea class="form-textarea" id="editBTDiag"></textarea></div>
        <div class="form-group"><label class="form-label">Type action</label><select class="form-select" id="editBTAction"><option value="Correctif">Correctif</option><option value="Pr√©ventif">Pr√©ventif</option><option value="Am√©lioratif">Am√©lioratif</option></select></div>
        <div class="form-group"><label class="form-label">D√©tail</label><textarea class="form-textarea" id="editBTDetail"></textarea></div>
        <button class="btn btn-warning" style="width:100%;margin-top:16px" id="btnSaveEditBT">üíæ Sauvegarder BT</button>
    </div>
</div>

<!-- v8.3: MODAL STATUT BT -->
<div class="modal" id="modalStatutBT">
    <div class="modal-content">
        <div class="modal-header"><h3>üìä Changer Statut BT</h3><button class="modal-close" onclick="closeModal('modalStatutBT')">‚úï</button></div>
        <div class="bt-card" id="modalStatutBTInfo"></div>
        <div class="statut-workflow">
            <div class="statut-title">Workflow de validation :</div>
            <div class="statut-steps">
                <div class="statut-step" data-statut="En cours"><span class="statut-icon">üîß</span>En cours</div>
                <div class="statut-arrow">‚Üí</div>
                <div class="statut-step" data-statut="En attente pi√®ces"><span class="statut-icon">üì¶</span>Attente pi√®ces</div>
                <div class="statut-arrow">‚Üí</div>
                <div class="statut-step" data-statut="Termin√©"><span class="statut-icon">‚úÖ</span>Termin√©</div>
                <div class="statut-arrow">‚Üí</div>
                <div class="statut-step" data-statut="Valid√©"><span class="statut-icon">‚úîÔ∏è</span>Valid√©</div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Nouveau statut *</label>
            <select class="form-select" id="selectNewStatut">
                <option value="En cours">üîß En cours</option>
                <option value="En attente pi√®ces">üì¶ En attente pi√®ces</option>
                <option value="Termin√©">‚úÖ Termin√©</option>
                <option value="Valid√©">‚úîÔ∏è Valid√© (Admin)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Commentaire (optionnel)</label>
            <textarea class="form-textarea" id="statutComment" placeholder="Raison du changement..."></textarea>
        </div>
        <button class="btn btn-success" style="width:100%;margin-top:16px" id="btnSaveStatut">üíæ Valider le changement</button>
    </div>
</div>

<div class="print-area" id="printArea"></div>
<div class="toast" id="toast"></div>
<script>
// CONFIG
const API_URL = 'https://script.google.com/macros/s/AKfycbz5M6pvIvkbUaP2zpu9hOWR9DSPRmUeAmpI-kaC4xbAzTAQhoNkjNVjbTlgxgXxMc4L/exec';
const API_TOKEN = 'BAHIA2024SECRET';

// STATE
let user = null;
let db = { machines: [], zones: [], composants: [], anomalies: [], techniciens: [], pieces: [] };
let allDI = [], allBT = [], allSorties = [];
let signalData = { ligne: '', machine: '', zone: '', composant: '', anomalie: '', techniciens: [] };
let timerInterval = null, timerSeconds = 0, timerRunning = false;
let currentDI = null, selectedPieces = [], currentBT = null;
let editingDI = null, editingBT = null; // v8.1: pour modification
let photoData = null; // v8.3: photo base64

// INIT
document.addEventListener('DOMContentLoaded', () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
    }
    const saved = localStorage.getItem('gmao_user');
    if (saved) { try { user = JSON.parse(saved); showApp(); } catch(e) { localStorage.removeItem('gmao_user'); } }
    
    // Event listeners
    document.getElementById('btnLogin').addEventListener('click', doLogin);
    document.getElementById('loginPass').addEventListener('keypress', e => { if(e.key==='Enter') doLogin(); });
    document.getElementById('btnRefresh').addEventListener('click', () => { loadAllData(); toast('üîÑ Actualis√©'); });
    document.getElementById('btnLogout').addEventListener('click', doLogout);
    document.getElementById('btnSaveDI').addEventListener('click', saveDI);
    document.getElementById('btnWhatsApp').addEventListener('click', sendWhatsApp);
    document.getElementById('timerStartBtn').addEventListener('click', toggleTimer);
    document.getElementById('timerResetBtn').addEventListener('click', resetTimer);
    document.getElementById('commentInput').addEventListener('input', updatePreview);
    document.getElementById('searchBT').addEventListener('input', () => renderBTList(document.getElementById('searchBT').value));
    document.getElementById('searchPiece').addEventListener('input', () => renderPieces(document.getElementById('searchPiece').value));
    document.getElementById('searchPieceModal').addEventListener('input', () => renderModalPieces(document.getElementById('searchPieceModal').value));
    document.getElementById('closeTraitement').addEventListener('click', () => closeModal('modalTraitement'));
    document.getElementById('closeBT').addEventListener('click', () => closeModal('modalBT'));
    document.getElementById('btnCloseDI').addEventListener('click', closeDI);
    document.getElementById('btnPrintBT').addEventListener('click', printBT);
    document.getElementById('btnShareBT').addEventListener('click', shareBTWhatsApp);
    
    // v8.3 - Photo
    document.getElementById('btnTakePhoto').addEventListener('click', () => document.getElementById('photoInput').click());
    document.getElementById('photoInput').addEventListener('change', handlePhotoSelect);
    document.getElementById('btnRemovePhoto').addEventListener('click', removePhoto);
    
    // v8.3 - Dashboard filtres
    document.getElementById('filterPeriod').addEventListener('change', updateDashboard);
    document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
    
    // v8.3 - Historique filtres
    document.getElementById('histDIDateFrom').addEventListener('change', renderHistoriqueDI);
    document.getElementById('histDIDateTo').addEventListener('change', renderHistoriqueDI);
    document.getElementById('histDIUser').addEventListener('change', renderHistoriqueDI);
    document.getElementById('histDIStatus').addEventListener('change', renderHistoriqueDI);
    document.getElementById('histBTDateFrom').addEventListener('change', renderHistoriqueBT);
    document.getElementById('histBTDateTo').addEventListener('change', renderHistoriqueBT);
    document.getElementById('histBTUser').addEventListener('change', renderHistoriqueBT);
    document.getElementById('histBTMachine').addEventListener('change', renderHistoriqueBT);
    
    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const page = btn.dataset.page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.action-bar').forEach(a => a.classList.remove('show'));
            document.getElementById(page).classList.add('active');
            btn.classList.add('active');
            if (page === 'pageSignal') document.getElementById('signalActionBar').classList.add('show');
            if (page === 'pageHistorique') { populateHistoriqueFilters(); renderHistoriqueDI(); }
        });
    });
    
    // Tabs
    document.querySelectorAll('.tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const parent = btn.closest('.page');
            const tab = btn.dataset.tab;
            parent.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            if (tab === 'new') { document.getElementById('tabSignalNew').classList.add('active'); document.getElementById('signalActionBar').classList.add('show'); }
            else if (tab === 'history') { document.getElementById('tabSignalHistory').classList.add('active'); document.getElementById('signalActionBar').classList.remove('show'); renderMyDIs(); }
            else if (tab === 'di') document.getElementById('tabMaintDI').classList.add('active');
            else if (tab === 'bt') document.getElementById('tabMaintBT').classList.add('active');
            else if (tab === 'stock') document.getElementById('tabPDRStock').classList.add('active');
            else if (tab === 'sorties') { document.getElementById('tabPDRSorties').classList.add('active'); renderSorties(); }
            else if (tab === 'histDI') { document.getElementById('tabHistDI').classList.add('active'); renderHistoriqueDI(); }
            else if (tab === 'histBT') { document.getElementById('tabHistBT').classList.add('active'); renderHistoriqueBT(); }
        });
    });
    
    // Recherche Historique
    document.getElementById('searchHistDI').addEventListener('input', renderHistoriqueDI);
    document.getElementById('searchHistBT').addEventListener('input', renderHistoriqueBT);
    
    // Modal backdrop close
    document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target === m) m.classList.remove('show'); }));
});

// API
async function apiCall(action, params = {}) {
    try {
        const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, token: API_TOKEN, ...params }) });
        return await r.json();
    } catch(e) { return { success: false, error: e.message }; }
}

// AUTH
async function doLogin() {
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    const errorEl = document.getElementById('loginError');
    if (!username || !password) { errorEl.textContent = 'Remplir tous les champs'; errorEl.style.display = 'block'; return; }
    errorEl.style.display = 'none';
    const btn = document.getElementById('btnLogin');
    btn.disabled = true; btn.textContent = '‚è≥ Connexion...';
    const result = await apiCall('login', { username, password });
    if (result.success) {
        user = result.user;
        if (document.getElementById('rememberMe').checked) localStorage.setItem('gmao_user', JSON.stringify(user));
        showApp();
    } else { errorEl.textContent = result.error || 'Erreur'; errorEl.style.display = 'block'; }
    btn.disabled = false; btn.textContent = 'üöÄ Connexion';
}

function doLogout() {
    if (confirm('D√©connexion ?')) {
        user = null; localStorage.removeItem('gmao_user');
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('mainApp').classList.remove('active');
    }
}

async function showApp() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('userAvatar').textContent = user.nom.charAt(0).toUpperCase();
    document.getElementById('userName').textContent = user.nom;
    document.getElementById('userRole').textContent = user.role;
    document.querySelector('#operatorBadge .badge-name').textContent = user.nom;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // v8.2 - RESTRICTIONS D'ACC√àS PAR R√îLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    applyRoleRestrictions();
    
    await loadData();
}

function applyRoleRestrictions() {
    const role = (user.role || '').toLowerCase();
    
    // R√©cup√©rer les boutons de navigation
    const navSignal = document.querySelector('[data-page="pageSignal"]');
    const navMaint = document.querySelector('[data-page="pageMaint"]');
    const navHistorique = document.querySelector('[data-page="pageHistorique"]');
    const navPDR = document.querySelector('[data-page="pagePDR"]');
    
    // Par d√©faut, tout afficher
    navSignal.style.display = 'flex';
    navMaint.style.display = 'flex';
    navHistorique.style.display = 'flex'; // Toujours visible pour tous
    navPDR.style.display = 'flex';
    
    // Appliquer restrictions selon le r√¥le
    if (role === 'technicien') {
        // Technicien : Maintenance + Historique + PDR (PAS Signaler)
        navSignal.style.display = 'none';
    } 
    else if (role === 'operateur' || role === 'op√©rateur' || role === 'production') {
        // Op√©rateur/Production : Signaler + Historique (PAS Maintenance, PAS PDR)
        navMaint.style.display = 'none';
        navPDR.style.display = 'none';
    }
    // Admin : acc√®s total (par d√©faut)
    
    console.log('Restrictions appliqu√©es pour le r√¥le:', role);
}

async function loadData() {
    setStatus(false, 'Chargement...');
    const result = await apiCall('getData');
    if (result.success) { db = result; setStatus(true, 'Connect√©'); initSignalForm(); await loadAllData(); }
    else { setStatus(false, 'Erreur'); toast('‚ùå Erreur connexion'); }
}

async function loadAllData() {
    await Promise.all([loadDIs(), loadBTs(), loadSorties()]);
    updateDashboard(); renderPieces();
}

function setStatus(online, text) {
    document.getElementById('statusDot').className = 'status-dot' + (online ? ' online' : '');
    document.getElementById('statusText').textContent = text;
}

// SIGNALEMENT
function initSignalForm() {
    const lignes = [...new Set((db.machines || []).map(m => m.Ligne).filter(Boolean))];
    document.getElementById('lignesChips').innerHTML = lignes.map(l => `<div class="chip" data-value="${l}">${l}</div>`).join('');
    document.getElementById('techsGrid').innerHTML = (db.techniciens || []).map(t => `<div class="tech-item" data-name="${t.Nom}"><input type="checkbox"><span class="tech-name">${t.Nom}</span></div>`).join('');
    document.getElementById('anomaliesChips').innerHTML = (db.anomalies || []).map(a => `<div class="chip" data-value="${a.Anomalie}">${a.Anomalie}</div>`).join('');
    
    // Chip click handlers
    document.querySelectorAll('#lignesChips .chip').forEach(c => c.addEventListener('click', () => selectLigne(c)));
    document.querySelectorAll('#anomaliesChips .chip').forEach(c => c.addEventListener('click', () => selectAnomalie(c)));
    document.querySelectorAll('#techsGrid .tech-item').forEach(t => t.addEventListener('click', () => toggleTech(t)));
    resetSignalForm();
}

function selectLigne(el) {
    signalData = { ligne: el.dataset.value, machine: '', zone: '', composant: '', anomalie: '', techniciens: [] };
    document.querySelectorAll('#lignesChips .chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const machines = (db.machines || []).filter(m => m.Ligne === signalData.ligne);
    document.getElementById('machinesChips').innerHTML = machines.map(m => `<div class="chip" data-value="${m.Machine}">${m.Machine}</div>`).join('');
    document.querySelectorAll('#machinesChips .chip').forEach(c => c.addEventListener('click', () => selectMachine(c)));
    showStep(3); hideSteps([4,5,6,7,8,9]); document.getElementById('previewCard').classList.add('hidden'); updatePreview();
}

function selectMachine(el) {
    signalData.machine = el.dataset.value; signalData.zone = ''; signalData.composant = '';
    document.querySelectorAll('#machinesChips .chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const zones = (db.zones || []).filter(z => z.Machine === signalData.machine);
    document.getElementById('zonesChips').innerHTML = zones.map(z => `<div class="chip" data-value="${z.Zone}">${z.Zone}</div>`).join('');
    document.querySelectorAll('#zonesChips .chip').forEach(c => c.addEventListener('click', () => selectZone(c)));
    showStep(4); hideSteps([5,6,7,8,9]); updatePreview();
}

function selectZone(el) {
    signalData.zone = el.dataset.value; signalData.composant = '';
    document.querySelectorAll('#zonesChips .chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const composants = (db.composants || []).filter(c => c.Zone === signalData.zone);
    document.getElementById('composantsChips').innerHTML = composants.map(c => `<div class="chip" data-value="${c.Composant}">${c.Composant}</div>`).join('');
    document.querySelectorAll('#composantsChips .chip').forEach(c => c.addEventListener('click', () => selectComposant(c)));
    showStep(5); hideSteps([6,7,8,9]); updatePreview();
}

function selectComposant(el) {
    signalData.composant = el.dataset.value;
    document.querySelectorAll('#composantsChips .chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    showSteps([6,7,8,9]); document.getElementById('previewCard').classList.remove('hidden'); updatePreview();
}

function selectAnomalie(el) {
    signalData.anomalie = el.dataset.value;
    document.querySelectorAll('#anomaliesChips .chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected'); updatePreview();
}

function toggleTech(el) {
    el.classList.toggle('selected');
    const cb = el.querySelector('input'); cb.checked = !cb.checked;
    const name = el.dataset.name;
    if (cb.checked) { if (!signalData.techniciens.includes(name)) signalData.techniciens.push(name); }
    else { signalData.techniciens = signalData.techniciens.filter(t => t !== name); }
    updatePreview();
}

function showStep(n) { document.getElementById('step' + n).classList.remove('hidden'); }
function hideSteps(arr) { arr.forEach(n => document.getElementById('step' + n).classList.add('hidden')); }
function showSteps(arr) { arr.forEach(n => document.getElementById('step' + n).classList.remove('hidden')); }

function updatePreview() {
    const comment = document.getElementById('commentInput').value;
    const duration = timerSeconds > 0 ? formatDuration(timerSeconds) : '';
    let msg = `üö® *DEMANDE D'INTERVENTION*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë§ ${user.nom}\n`;
    if (signalData.ligne) msg += `üìç Ligne: ${signalData.ligne}\n`;
    if (signalData.machine) msg += `‚öôÔ∏è Machine: ${signalData.machine}\n`;
    if (signalData.zone) msg += `üîß Zone: ${signalData.zone}\n`;
    if (signalData.composant) msg += `üî© Composant: ${signalData.composant}\n`;
    if (signalData.anomalie) msg += `‚ö†Ô∏è Anomalie: ${signalData.anomalie}\n`;
    if (signalData.techniciens.length) msg += `üë®‚Äçüîß Techniciens: ${signalData.techniciens.join(', ')}\n`;
    if (duration) msg += `‚è±Ô∏è Dur√©e: ${duration}\n`;
    if (comment) msg += `üí¨ ${comment}\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚è≥ En attente`;
    document.getElementById('previewBox').textContent = msg;
    const valid = signalData.ligne && signalData.machine && signalData.zone && signalData.composant && signalData.anomalie;
    document.getElementById('btnSaveDI').disabled = !valid;
    document.getElementById('btnWhatsApp').disabled = !valid;
}

function resetSignalForm() {
    signalData = { ligne: '', machine: '', zone: '', composant: '', anomalie: '', techniciens: [] };
    document.querySelectorAll('#tabSignalNew .chip').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('#tabSignalNew .tech-item').forEach(t => { t.classList.remove('selected'); t.querySelector('input').checked = false; });
    document.getElementById('commentInput').value = '';
    hideSteps([3,4,5,6,7,8]); document.getElementById('previewCard').classList.add('hidden');
    document.getElementById('successBox').classList.add('hidden');
    [1,2].forEach(n => document.getElementById('step' + n).classList.remove('hidden'));
    resetTimer(); updatePreview();
}

function toggleTimer() {
    if (timerRunning) { clearInterval(timerInterval); timerRunning = false; document.getElementById('timerStartBtn').textContent = '‚ñ∂Ô∏è D√©marrer'; }
    else { timerInterval = setInterval(() => { timerSeconds++; document.getElementById('timerDisplay').textContent = formatDuration(timerSeconds); updatePreview(); }, 1000); timerRunning = true; document.getElementById('timerStartBtn').textContent = '‚è∏Ô∏è Pause'; }
}

function resetTimer() { clearInterval(timerInterval); timerRunning = false; timerSeconds = 0; document.getElementById('timerDisplay').textContent = '00:00:00'; document.getElementById('timerStartBtn').textContent = '‚ñ∂Ô∏è D√©marrer'; }

function formatDuration(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

async function saveDI() {
    const btn = document.getElementById('btnSaveDI');
    btn.disabled = true; btn.innerHTML = '‚è≥ Enregistrement...';
    const result = await apiCall('saveAnomalie', {
        operateur: user.nom, ligne: signalData.ligne, machine: signalData.machine, zone: signalData.zone,
        composant: signalData.composant, anomalie: signalData.anomalie, techniciens: signalData.techniciens.join(', '),
        duree: timerSeconds > 0 ? Math.ceil(timerSeconds / 60) : 0, commentaire: document.getElementById('commentInput').value, 
        userId: user.id, photo: photoData || '' // v8.3: photo
    });
    if (result.success) {
        document.getElementById('successId').textContent = result.id;
        [1,2,3,4,5,6,7,8,9].forEach(n => { const s = document.getElementById('step'+n); if(s) s.classList.add('hidden'); });
        document.getElementById('previewCard').classList.add('hidden');
        document.querySelector('.timer-card').classList.add('hidden');
        document.getElementById('successBox').classList.remove('hidden');
        document.getElementById('signalActionBar').classList.remove('show');
        toast('‚úÖ DI enregistr√©e');
        removePhoto(); // v8.3: reset photo
        await loadAllData();
        // v8.1: WhatsApp manuel uniquement - pas de popup automatique
        setTimeout(() => { document.querySelector('.timer-card').classList.remove('hidden'); resetSignalForm(); }, 3000);
    } else { toast('‚ùå ' + (result.error || 'Erreur')); }
    btn.disabled = false; btn.innerHTML = 'üíæ Enregistrer DI';
}

function sendWhatsApp() { window.open('https://wa.me/?text=' + encodeURIComponent(document.getElementById('previewBox').textContent), '_blank'); }

// DI
async function loadDIs() {
    const result = await apiCall('getAnomalies');
    if (result.success) { allDI = result.data || []; updateDIBadges(); renderDIList(); }
}

function updateDIBadges() {
    const waiting = allDI.filter(di => di.Statut === 'En attente').length;
    document.getElementById('diWaitingCount').textContent = waiting;
    document.getElementById('navDIBadge').textContent = waiting;
    document.getElementById('navDIBadge').style.display = waiting > 0 ? 'flex' : 'none';
    document.getElementById('myDICount').textContent = allDI.filter(di => di.Operateur === user.nom).length;
}

function renderMyDIs() {
    const myDIs = allDI.filter(di => di.Operateur === user.nom);
    if (!myDIs.length) { document.getElementById('myDIList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun signalement</div></div>'; return; }
    // v8.2: Boutons Modifier et Supprimer pour DI en attente
    document.getElementById('myDIList').innerHTML = myDIs.map(di => {
        const canEdit = di.Statut === 'En attente';
        return `<div class="di-card ${di.Statut==='Cl√¥tur√©'?'done':''}">
            <div class="di-header"><div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div><span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut}</span></div>
            <div class="di-machine">‚öôÔ∏è ${di.Machine}</div>
            <div class="di-info">üìç ${di.Ligne} | üîß ${di.Zone}</div>
            <div class="di-info">üî© ${di.Composant} | ‚ö†Ô∏è ${di.Anomalie}</div>
            ${di.BT_ID?`<div class="di-info" style="color:var(--secondary)">‚Üí ${di.BT_ID}</div>`:''}
            ${canEdit?`<div class="di-actions"><button class="di-btn warning" onclick="openEditDI('${di.ID}')">‚úèÔ∏è Modifier</button><button class="di-btn" style="background:var(--danger);color:#fff" onclick="confirmDeleteDI('${di.ID}')">üóëÔ∏è Supprimer</button></div>`:''}
        </div>`;
    }).join('');
}

function renderDIList() {
    const waiting = allDI.filter(di => di.Statut === 'En attente');
    if (!waiting.length) { document.getElementById('diWaitingList').innerHTML = '<div class="list-empty"><div class="empty-icon">‚úÖ</div><div>Aucune DI en attente</div></div>'; return; }
    document.getElementById('diWaitingList').innerHTML = waiting.map(di => `<div class="di-card"><div class="di-header"><div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div><span class="di-badge waiting">En attente</span></div><div class="di-machine">‚öôÔ∏è ${di.Machine}</div><div class="di-info">üìç ${di.Ligne} | üîß ${di.Zone}</div><div class="di-info">üî© ${di.Composant} | ‚ö†Ô∏è ${di.Anomalie}</div><div class="di-info">üë§ ${di.Operateur}</div>${di.Duree?`<div class="di-info">‚è±Ô∏è ${di.Duree} min</div>`:''}<div class="di-actions"><button class="di-btn primary" onclick="openTraitement('${di.ID}')">üîß Traiter</button></div></div>`).join('');
}

function openTraitement(diId) {
    currentDI = allDI.find(di => di.ID === diId); if (!currentDI) return;
    selectedPieces = [];
    document.getElementById('modalDIInfo').innerHTML = `<div class="di-header"><div><div class="di-id">${currentDI.ID}</div><div class="di-date">${currentDI.Date||''}</div></div></div><div class="di-machine">‚öôÔ∏è ${currentDI.Machine}</div><div class="di-info">üìç ${currentDI.Ligne} | üîß ${currentDI.Zone}</div><div class="di-info">üî© ${currentDI.Composant} | ‚ö†Ô∏è ${currentDI.Anomalie}</div>`;
    document.getElementById('traitCause').value = '';
    document.getElementById('traitDiag').value = '';
    document.getElementById('traitAction').value = '';
    document.getElementById('traitDetail').value = '';
    document.getElementById('searchPieceModal').value = '';
    renderModalPieces(); openModal('modalTraitement');
}

function renderModalPieces(filter = '') {
    let pieces = db.pieces || [];
    if (filter) { const f = filter.toLowerCase(); pieces = pieces.filter(p => (p.Code_JDE||'').toLowerCase().includes(f) || (p.Designation||'').toLowerCase().includes(f)); }
    document.getElementById('modalPiecesList').innerHTML = pieces.slice(0,30).map(p => `<div class="piece-item" onclick="togglePiece('${p.Code_JDE}','${(p.Designation||'').replace(/'/g,"\\'")}',${p.Stock||0})"><input type="checkbox" class="piece-check" ${selectedPieces.find(sp=>sp.code===p.Code_JDE)?'checked':''}><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation||'-'}</div><div class="piece-stock">Stock: ${p.Stock||0}</div></div></div>`).join('');
    renderSelectedPieces();
}

function togglePiece(code, name, stock) {
    const idx = selectedPieces.findIndex(p => p.code === code);
    if (idx >= 0) selectedPieces.splice(idx, 1); else selectedPieces.push({ code, name, stock, qty: 1 });
    renderModalPieces(document.getElementById('searchPieceModal').value);
}

function renderSelectedPieces() {
    if (!selectedPieces.length) { document.getElementById('selectedPiecesDisplay').innerHTML = '<div style="color:var(--gray-400);font-size:13px;margin-top:10px">Aucune pi√®ce</div>'; return; }
    document.getElementById('selectedPiecesDisplay').innerHTML = selectedPieces.map((p,i) => `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--gray-50);border-radius:10px;margin-top:8px"><div style="flex:1"><div style="font-weight:600">${p.code}</div><div style="font-size:12px;color:var(--gray-500)">${p.name}</div></div><input type="number" value="${p.qty}" min="1" max="${p.stock}" style="width:60px;padding:8px;border:2px solid var(--gray-200);border-radius:8px" onchange="updatePieceQty(${i},this.value)"><button onclick="removePiece(${i})" style="background:var(--danger);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer">‚úï</button></div>`).join('');
}

function updatePieceQty(idx, qty) { selectedPieces[idx].qty = parseInt(qty) || 1; }
function removePiece(idx) { selectedPieces.splice(idx, 1); renderModalPieces(document.getElementById('searchPieceModal').value); }

async function closeDI() {
    if (!currentDI) return;
    const cause = document.getElementById('traitCause').value;
    const diagnostic = document.getElementById('traitDiag').value;
    const actionType = document.getElementById('traitAction').value;
    const actionDetail = document.getElementById('traitDetail').value;
    if (!cause || !diagnostic || !actionType || !actionDetail) { toast('‚ö†Ô∏è Remplir tous les champs'); return; }
    const btn = document.getElementById('btnCloseDI');
    btn.disabled = true; btn.textContent = '‚è≥ Traitement...';
    const result = await apiCall('cloturerDI', { diId: currentDI.ID, technicien: user.nom, cause, diagnostic, actionType, actionDetail, pieces: selectedPieces, userId: user.id });
    if (result.success) {
        toast('‚úÖ BT g√©n√©r√©: ' + result.btId);
        closeModal('modalTraitement');
        await loadAllData();
        // v8.1: WhatsApp manuel uniquement - pas de popup automatique
    } else { toast('‚ùå ' + (result.error || 'Erreur')); }
    btn.disabled = false; btn.textContent = '‚úÖ Cl√¥turer DI et G√©n√©rer BT';
}

function sendBTNotification(btId, di) {
    let msg = `‚úÖ *INTERVENTION TERMIN√âE*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã BT: ${btId}\nüîó R√©f: ${di.ID}\n‚öôÔ∏è ${di.Machine}\n‚ö†Ô∏è ${di.Anomalie}\nüë®‚Äçüîß ${user.nom}\nüìÖ ${new Date().toLocaleDateString('fr-FR')}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
    window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}

// BT
async function loadBTs() { const r = await apiCall('getBTs'); if (r.success) { allBT = r.data || []; renderBTList(); } }

function getStatutClass(statut) {
    switch(statut) {
        case 'En cours': return 'en-cours';
        case 'En attente pi√®ces': return 'attente-pieces';
        case 'Termin√©': return 'termine';
        case 'Valid√©': return 'valide';
        default: return 'en-cours';
    }
}

function getStatutIcon(statut) {
    switch(statut) {
        case 'En cours': return 'üîß';
        case 'En attente pi√®ces': return 'üì¶';
        case 'Termin√©': return '‚úÖ';
        case 'Valid√©': return '‚úîÔ∏è';
        default: return 'üîß';
    }
}

function renderBTList(filter = '') {
    let bts = allBT;
    if (filter) { const f = filter.toLowerCase(); bts = bts.filter(bt => (bt.BT_ID||'').toLowerCase().includes(f) || (bt.Anomalie_ID||'').toLowerCase().includes(f) || (bt.Machine||'').toLowerCase().includes(f)); }
    if (!bts.length) { document.getElementById('btList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun BT</div></div>'; return; }
    
    // v8.3: Affichage avec statuts
    document.getElementById('btList').innerHTML = bts.map(bt => {
        const statut = bt.Statut_BT || 'En cours';
        const statutClass = getStatutClass(statut);
        const statutIcon = getStatutIcon(statut);
        const canChangeStatut = user.role === 'admin' || user.role === 'technicien';
        const canValidate = user.role === 'admin';
        
        return `<div class="bt-card">
            <div class="bt-header" onclick="openBTDetail('${bt.BT_ID}')">
                <div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">R√©f: ${bt.Anomalie_ID||'-'}</div></div>
                <span class="bt-statut ${statutClass}">${statutIcon} ${statut}</span>
            </div>
            <div class="bt-grid" onclick="openBTDetail('${bt.BT_ID}')">
                <div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div>
                <div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${bt.Technicien||'-'}</div></div>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                ${canChangeStatut && statut !== 'Valid√©' ? `<button class="di-btn primary" style="flex:1" onclick="event.stopPropagation();openChangeStatut('${bt.BT_ID}')">üìä Statut</button>` : ''}
                <button class="di-btn warning" onclick="event.stopPropagation();openEditBT('${bt.BT_ID}')">‚úèÔ∏è</button>
                <button class="di-btn" style="background:var(--danger);color:#fff" onclick="event.stopPropagation();confirmDeleteBT('${bt.BT_ID}')">üóëÔ∏è</button>
            </div>
        </div>`;
    }).join('');
}

function openBTDetail(btId) {
    currentBT = allBT.find(b => b.BT_ID === btId); if (!currentBT) return;
    let piecesHtml = '';
    const statut = currentBT.Statut_BT || 'En cours';
    const statutClass = getStatutClass(statut);
    const statutIcon = getStatutIcon(statut);
    // v8.1: Pi√®ces en noir (pas blanc sur fond clair)
    if (currentBT.Pieces) { try { const pieces = JSON.parse(currentBT.Pieces); if (pieces.length) piecesHtml = `<div style="background:#f1f5f9;border-radius:12px;padding:12px;margin-top:12px"><div style="font-size:12px;color:#475569;text-transform:uppercase;margin-bottom:8px">üì¶ Pi√®ces utilis√©es</div>${pieces.map(p=>`<div style="font-size:14px;margin-top:6px;color:#1e293b">‚Ä¢ ${p.code} √ó ${p.qty}</div>`).join('')}</div>`; } catch(e){} }
    // v8.3: Historique des statuts
    let historiqueHtml = '';
    if (currentBT.Historique_Statut) {
        try {
            const hist = JSON.parse(currentBT.Historique_Statut);
            if (hist.length) {
                historiqueHtml = `<div style="background:#f1f5f9;border-radius:12px;padding:12px;margin-top:12px"><div style="font-size:12px;color:#475569;text-transform:uppercase;margin-bottom:8px">üìú Historique statuts</div>${hist.map(h=>`<div style="font-size:13px;margin-top:6px;color:#1e293b">‚Ä¢ ${h.date} - <strong>${h.statut}</strong> par ${h.user}${h.comment ? ' - ' + h.comment : ''}</div>`).join('')}</div>`;
            }
        } catch(e) {}
    }
    document.getElementById('modalBTContent').innerHTML = `<div class="bt-card" style="cursor:default">
        <div class="bt-header"><div><div class="bt-id">${currentBT.BT_ID}</div><div class="bt-ref">R√©f: ${currentBT.Anomalie_ID||'-'}</div></div><span class="bt-statut ${statutClass}">${statutIcon} ${statut}</span></div>
        <div class="bt-section"><div class="bt-section-title">Date</div><div class="bt-section-value">${currentBT.Date||'-'}</div></div>
        <div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${currentBT.Machine||'-'}</div></div>
        <div class="bt-grid"><div class="bt-section"><div class="bt-section-title">Cause</div><div class="bt-section-value">${currentBT.Cause||'-'}</div></div><div class="bt-section"><div class="bt-section-title">Action</div><div class="bt-section-value">${currentBT.Action_Type||'-'}</div></div></div>
        <div class="bt-section"><div class="bt-section-title">Diagnostic</div><div class="bt-section-value">${currentBT.Diagnostic||'-'}</div></div>
        <div class="bt-section"><div class="bt-section-title">D√©tail</div><div class="bt-section-value">${currentBT.Action_Detail||'-'}</div></div>
        ${piecesHtml}
        <div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${currentBT.Technicien||'-'}</div></div>
        ${historiqueHtml}
    </div>`;
    openModal('modalBT');
}

function printBT() {
    if (!currentBT) return;
    let piecesRows = '';
    if (currentBT.Pieces) { try { const pieces = JSON.parse(currentBT.Pieces); piecesRows = pieces.map(p=>`<tr><td>${p.code}</td><td>${p.name||'-'}</td><td>${p.qty}</td></tr>`).join(''); } catch(e){} }
    document.getElementById('printArea').innerHTML = `<div style="text-align:center;border-bottom:2px solid #000;padding-bottom:15px;margin-bottom:20px"><h1>BON DE TRAVAIL</h1><p>GMAO BAHIA</p></div><p><strong>N¬∞:</strong> ${currentBT.BT_ID}</p><p><strong>R√©f DI:</strong> ${currentBT.Anomalie_ID||'-'}</p><p><strong>Date:</strong> ${currentBT.Date||'-'}</p><hr><p><strong>Machine:</strong> ${currentBT.Machine||'-'}</p><p><strong>Cause:</strong> ${currentBT.Cause||'-'}</p><p><strong>Diagnostic:</strong> ${currentBT.Diagnostic||'-'}</p><p><strong>Action:</strong> ${currentBT.Action_Type||'-'}</p><p><strong>D√©tail:</strong> ${currentBT.Action_Detail||'-'}</p><p><strong>Technicien:</strong> ${currentBT.Technicien||'-'}</p>${piecesRows?`<h3>Pi√®ces</h3><table border="1" style="width:100%;border-collapse:collapse"><tr><th>Code</th><th>D√©signation</th><th>Qt√©</th></tr>${piecesRows}</table>`:''}<p style="margin-top:50px"><strong>Signature:</strong> _____________</p>`;
    window.print();
}

function shareBTWhatsApp() {
    if (!currentBT) return;
    // v8.1: Ajouter les pi√®ces dans le message WhatsApp
    let piecesText = '';
    if (currentBT.Pieces) {
        try {
            const pieces = JSON.parse(currentBT.Pieces);
            if (pieces.length) {
                piecesText = `\nüì¶ Pi√®ces: ${pieces.map(p => p.code + ' √ó' + p.qty).join(', ')}`;
            }
        } catch(e) {}
    }
    let msg = `üìÑ *BON DE TRAVAIL*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã ${currentBT.BT_ID}\nüîó R√©f: ${currentBT.Anomalie_ID||'-'}\nüìÖ ${currentBT.Date||'-'}\n‚öôÔ∏è ${currentBT.Machine||'-'}\nüîß ${currentBT.Cause||'-'}\nüõ†Ô∏è ${currentBT.Action_Type||'-'}\nüë®‚Äçüîß ${currentBT.Technicien||'-'}${piecesText}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
    window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIQUE (Lecture seule pour tous les r√¥les)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderHistoriqueDI(filter = '') {
    let dis = allDI;
    if (filter) {
        const f = filter.toLowerCase();
        dis = dis.filter(di => 
            (di.ID||'').toLowerCase().includes(f) || 
            (di.Machine||'').toLowerCase().includes(f) || 
            (di.Anomalie||'').toLowerCase().includes(f) ||
            (di.Operateur||'').toLowerCase().includes(f)
        );
    }
    if (!dis.length) {
        document.getElementById('histDIList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune DI</div></div>';
        return;
    }
    // Lecture seule - pas de boutons d'action
    document.getElementById('histDIList').innerHTML = dis.map(di => `
        <div class="di-card ${di.Statut==='Cl√¥tur√©'?'done':''}">
            <div class="di-header">
                <div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div>
                <span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut}</span>
            </div>
            <div class="di-machine">‚öôÔ∏è ${di.Machine}</div>
            <div class="di-info">üìç ${di.Ligne} | üîß ${di.Zone}</div>
            <div class="di-info">üî© ${di.Composant} | ‚ö†Ô∏è ${di.Anomalie}</div>
            <div class="di-info">üë§ ${di.Operateur}</div>
            ${di.BT_ID?`<div class="di-info" style="color:var(--secondary)">‚Üí ${di.BT_ID}</div>`:''}
        </div>
    `).join('');
}

function renderHistoriqueBT(filter = '') {
    let bts = allBT;
    if (filter) {
        const f = filter.toLowerCase();
        bts = bts.filter(bt => 
            (bt.BT_ID||'').toLowerCase().includes(f) || 
            (bt.Anomalie_ID||'').toLowerCase().includes(f) || 
            (bt.Machine||'').toLowerCase().includes(f) ||
            (bt.Technicien||'').toLowerCase().includes(f)
        );
    }
    if (!bts.length) {
        document.getElementById('histBTList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun BT</div></div>';
        return;
    }
    // Lecture seule - clic pour voir d√©tail seulement
    document.getElementById('histBTList').innerHTML = bts.map(bt => `
        <div class="bt-card" onclick="openBTDetail('${bt.BT_ID}')">
            <div class="bt-header">
                <div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">R√©f: ${bt.Anomalie_ID||'-'}</div></div>
                <span style="font-size:13px">${bt.Date||''}</span>
            </div>
            <div class="bt-grid">
                <div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div>
                <div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${bt.Technicien||'-'}</div></div>
            </div>
        </div>
    `).join('');
}

// PDR
function renderPieces(filter = '') {
    let pieces = db.pieces || [];
    if (filter) { const f = filter.toLowerCase(); pieces = pieces.filter(p => (p.Code_JDE||'').toLowerCase().includes(f) || (p.Designation||'').toLowerCase().includes(f)); }
    if (!pieces.length) { document.getElementById('piecesList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune pi√®ce</div></div>'; return; }
    document.getElementById('piecesList').innerHTML = pieces.slice(0,100).map(p => {
        const stock = parseInt(p.Stock)||0, seuil = parseInt(p.Seuil_Alerte)||5, isLow = stock <= seuil;
        return `<div class="piece-item"><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation||'-'}</div><div class="piece-stock">Stock: <strong style="color:${isLow?'var(--danger)':'var(--success)'}">${stock}</strong> ${p.Unite||'U'} ${isLow?'<span class="stock-low">‚ö†Ô∏è Bas</span>':''}</div></div></div>`;
    }).join('');
}

async function loadSorties() { const r = await apiCall('getSorties'); if (r.success) allSorties = r.data || []; }

function renderSorties() {
    if (!allSorties.length) { document.getElementById('sortiesList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune sortie</div></div>'; return; }
    document.getElementById('sortiesList').innerHTML = allSorties.slice(0,50).map(s => `<div class="list-item"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-weight:700;color:var(--secondary)">${s.BT_ID||'-'}</span><span style="font-size:12px;color:var(--gray-400)">${s.Date||''}</span></div><div style="font-weight:600">${s.Code||'-'}</div><div style="font-size:13px;color:var(--gray-600)">${s.Designation||'-'}</div><div style="font-size:13px;margin-top:4px">Qt√©: <strong>${s.Quantite||0}</strong></div></div>`).join('');
}

// DASHBOARD
function updateDashboard() {
    const period = document.getElementById('filterPeriod').value;
    const now = new Date();
    
    // Filtrer par p√©riode
    const filterByPeriod = (items, dateField) => {
        return items.filter(item => {
            if (!item[dateField]) return period === 'all';
            try {
                const parts = item[dateField].split('/');
                const d = new Date(parts[2], parts[1]-1, parts[0]);
                switch(period) {
                    case 'today': return d.toDateString() === now.toDateString();
                    case 'week': 
                        const weekAgo = new Date(now); weekAgo.setDate(now.getDate() - 7);
                        return d >= weekAgo;
                    case 'month': return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    case 'year': return d.getFullYear() === now.getFullYear();
                    default: return true;
                }
            } catch(e) { return period === 'all'; }
        });
    };
    
    const filteredDI = filterByPeriod(allDI, 'Date');
    const filteredBT = filterByPeriod(allBT, 'Date');
    
    // Stats de base
    const diWaiting = allDI.filter(di => di.Statut === 'En attente').length;
    const stockCritique = (db.pieces || []).filter(p => (parseInt(p.Stock)||0) <= (parseInt(p.Seuil_Alerte)||5)).length;
    
    document.getElementById('statDI').textContent = diWaiting;
    document.getElementById('statBT').textContent = filteredBT.length;
    document.getElementById('statResolved').textContent = filteredDI.filter(d => d.Statut === 'Cl√¥tur√©').length;
    document.getElementById('statStock').textContent = stockCritique;
    
    // KPIs avanc√©s
    // MTTR - Temps moyen de r√©paration
    const durations = filteredBT.map(bt => parseInt(bt.Duree) || 0).filter(d => d > 0);
    const mttr = durations.length ? Math.round(durations.reduce((a,b) => a+b, 0) / durations.length) : 0;
    document.getElementById('kpiMTTR').textContent = mttr ? mttr + ' min' : '--';
    
    // Taux de pannes
    const totalMachines = (db.machines || []).length || 1;
    const tauxPanne = Math.round((filteredDI.length / totalMachines) * 100);
    document.getElementById('kpiTauxPanne').textContent = tauxPanne + '%';
    
    // DI en retard (> 24h)
    const diRetard = allDI.filter(di => {
        if (di.Statut !== 'En attente' || !di.Date) return false;
        try {
            const parts = di.Date.split('/');
            const diDate = new Date(parts[2], parts[1]-1, parts[0]);
            const hoursDiff = (now - diDate) / (1000 * 60 * 60);
            return hoursDiff > 24;
        } catch(e) { return false; }
    }).length;
    document.getElementById('kpiRetard').textContent = diRetard;
    
    // Machine la plus critique
    const machineCount = {};
    filteredDI.forEach(di => { if (di.Machine) machineCount[di.Machine] = (machineCount[di.Machine] || 0) + 1; });
    const topMachine = Object.entries(machineCount).sort((a,b) => b[1] - a[1])[0];
    document.getElementById('kpiTopMachine').textContent = topMachine ? topMachine[0].substring(0,12) : '--';
    
    // Activit√© r√©cente
    const recent = [...allBT].slice(0,5);
    if (!recent.length) document.getElementById('recentActivity').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune activit√©</div></div>';
    else document.getElementById('recentActivity').innerHTML = recent.map(bt => `<div class="list-item" style="cursor:pointer" onclick="openBTDetail('${bt.BT_ID}')"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:700;color:var(--secondary)">${bt.BT_ID}</span><span style="font-size:12px;color:var(--gray-400)">${bt.Date||''}</span></div><div style="font-size:14px">${bt.Machine||'-'} - ${bt.Cause||'-'}</div></div>`).join('');
}

// UTILS
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.1 - FONCTIONS EDIT DI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openEditDI(diId) {
    editingDI = allDI.find(di => di.ID === diId);
    if (!editingDI || editingDI.Statut !== 'En attente') { toast('‚ùå DI non modifiable'); return; }
    
    // Remplir les selects
    const lignes = [...new Set((db.machines || []).map(m => m.Ligne).filter(Boolean))];
    document.getElementById('editDILigne').innerHTML = lignes.map(l => `<option value="${l}" ${l===editingDI.Ligne?'selected':''}>${l}</option>`).join('');
    
    populateEditDIMachine();
    document.getElementById('editDIMachine').value = editingDI.Machine;
    populateEditDIZone();
    document.getElementById('editDIZone').value = editingDI.Zone;
    populateEditDIComposant();
    document.getElementById('editDIComposant').value = editingDI.Composant;
    
    document.getElementById('editDIAnomalie').innerHTML = (db.anomalies || []).map(a => `<option value="${a.Anomalie}" ${a.Anomalie===editingDI.Anomalie?'selected':''}>${a.Anomalie}</option>`).join('');
    document.getElementById('editDIComment').value = editingDI.Commentaire || '';
    
    // Event listeners pour cascading
    document.getElementById('editDILigne').onchange = function() { populateEditDIMachine(); populateEditDIZone(); populateEditDIComposant(); };
    document.getElementById('editDIMachine').onchange = function() { populateEditDIZone(); populateEditDIComposant(); };
    document.getElementById('editDIZone').onchange = populateEditDIComposant;
    
    openModal('modalEditDI');
}

function populateEditDIMachine() {
    const ligne = document.getElementById('editDILigne').value;
    const machines = (db.machines || []).filter(m => m.Ligne === ligne);
    document.getElementById('editDIMachine').innerHTML = machines.map(m => `<option value="${m.Machine}">${m.Machine}</option>`).join('');
}

function populateEditDIZone() {
    const machine = document.getElementById('editDIMachine').value;
    const zones = (db.zones || []).filter(z => z.Machine === machine);
    document.getElementById('editDIZone').innerHTML = zones.map(z => `<option value="${z.Zone}">${z.Zone}</option>`).join('');
}

function populateEditDIComposant() {
    const zone = document.getElementById('editDIZone').value;
    const composants = (db.composants || []).filter(c => c.Zone === zone);
    document.getElementById('editDIComposant').innerHTML = composants.map(c => `<option value="${c.Composant}">${c.Composant}</option>`).join('');
}

async function saveEditDI() {
    if (!editingDI) return;
    const btn = document.getElementById('btnSaveEditDI');
    btn.disabled = true; btn.textContent = '‚è≥ Sauvegarde...';
    
    const result = await apiCall('updateDI', {
        diId: editingDI.ID,
        ligne: document.getElementById('editDILigne').value,
        machine: document.getElementById('editDIMachine').value,
        zone: document.getElementById('editDIZone').value,
        composant: document.getElementById('editDIComposant').value,
        anomalie: document.getElementById('editDIAnomalie').value,
        commentaire: document.getElementById('editDIComment').value
    });
    
    if (result.success) {
        toast('‚úÖ DI modifi√©e');
        closeModal('modalEditDI');
        await loadAllData();
        renderMyDIs();
    } else { toast('‚ùå ' + (result.error || 'Erreur')); }
    btn.disabled = false; btn.textContent = 'üíæ Sauvegarder';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.1 - FONCTIONS EDIT BT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openEditBT(btId) {
    editingBT = allBT.find(b => b.BT_ID === btId);
    if (!editingBT) { toast('‚ùå BT non trouv√©'); return; }
    
    document.getElementById('editBTCause').value = editingBT.Cause || 'Usure normale';
    document.getElementById('editBTDiag').value = editingBT.Diagnostic || '';
    document.getElementById('editBTAction').value = editingBT.Action_Type || 'Correctif';
    document.getElementById('editBTDetail').value = editingBT.Action_Detail || '';
    
    openModal('modalEditBT');
}

async function saveEditBT() {
    if (!editingBT) return;
    const btn = document.getElementById('btnSaveEditBT');
    btn.disabled = true; btn.textContent = '‚è≥ Sauvegarde...';
    
    const result = await apiCall('updateBT', {
        btId: editingBT.BT_ID,
        cause: document.getElementById('editBTCause').value,
        diagnostic: document.getElementById('editBTDiag').value,
        actionType: document.getElementById('editBTAction').value,
        actionDetail: document.getElementById('editBTDetail').value
    });
    
    if (result.success) {
        toast('‚úÖ BT modifi√©');
        closeModal('modalEditBT');
        await loadAllData();
    } else { toast('‚ùå ' + (result.error || 'Erreur')); }
    btn.disabled = false; btn.textContent = 'üíæ Sauvegarder BT';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.2 - FONCTIONS DELETE DI / BT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function confirmDeleteDI(diId) {
    if (!confirm('‚ö†Ô∏è Supprimer cette DI ?\n\nCette action est irr√©versible.')) return;
    
    toast('‚è≥ Suppression...');
    const result = await apiCall('deleteDI', { diId: diId });
    
    if (result.success) {
        toast('‚úÖ DI supprim√©e');
        await loadAllData();
        renderMyDIs();
    } else {
        toast('‚ùå ' + (result.error || 'Erreur'));
    }
}

async function confirmDeleteBT(btId) {
    if (!confirm('‚ö†Ô∏è Supprimer ce BT ?\n\nCette action est irr√©versible.')) return;
    
    toast('‚è≥ Suppression...');
    const result = await apiCall('deleteBT', { btId: btId });
    
    if (result.success) {
        toast('‚úÖ BT supprim√©');
        await loadAllData();
    } else {
        toast('‚ùå ' + (result.error || 'Erreur'));
    }
}

// Event listeners pour boutons Save Edit
document.getElementById('btnSaveEditDI').addEventListener('click', saveEditDI);
document.getElementById('btnSaveEditBT').addEventListener('click', saveEditBT);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.3 - FONCTIONS PHOTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function handlePhotoSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // V√©rifier la taille (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        toast('‚ùå Photo trop grande (max 5MB)');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(event) {
        photoData = event.target.result;
        document.getElementById('photoImg').src = photoData;
        document.getElementById('photoPreview').classList.remove('hidden');
        document.getElementById('btnTakePhoto').textContent = 'üì∑ Changer la photo';
    };
    reader.readAsDataURL(file);
}

function removePhoto() {
    photoData = null;
    document.getElementById('photoInput').value = '';
    document.getElementById('photoPreview').classList.add('hidden');
    document.getElementById('btnTakePhoto').textContent = 'üì∑ Prendre une photo';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.3 - EXPORT EXCEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function exportToExcel() {
    const period = document.getElementById('filterPeriod').value;
    const periodLabels = { today: "Aujourd'hui", week: 'Cette semaine', month: 'Ce mois', year: 'Cette ann√©e', all: 'Tout' };
    
    // Pr√©parer les donn√©es
    let csvContent = '\ufeff'; // BOM pour UTF-8 Excel
    
    // En-t√™te rapport
    csvContent += 'RAPPORT GMAO BAHIA\n';
    csvContent += 'P√©riode: ' + periodLabels[period] + '\n';
    csvContent += 'Date export: ' + new Date().toLocaleString('fr-FR') + '\n\n';
    
    // Section DI
    csvContent += '=== DEMANDES D\'INTERVENTION ===\n';
    csvContent += 'ID;Date;Op√©rateur;Machine;Zone;Anomalie;Statut;BT\n';
    allDI.forEach(di => {
        csvContent += `${di.ID||''};${di.Date||''};${di.Operateur||''};${di.Machine||''};${di.Zone||''};${di.Anomalie||''};${di.Statut||''};${di.BT_ID||''}\n`;
    });
    
    csvContent += '\n=== BONS DE TRAVAIL ===\n';
    csvContent += 'ID;Date;R√©f DI;Machine;Technicien;Cause;Action;Dur√©e\n';
    allBT.forEach(bt => {
        csvContent += `${bt.BT_ID||''};${bt.Date||''};${bt.Anomalie_ID||''};${bt.Machine||''};${bt.Technicien||''};${bt.Cause||''};${bt.Action_Type||''};${bt.Duree||''}\n`;
    });
    
    // KPIs
    csvContent += '\n=== KPIs ===\n';
    csvContent += 'DI en attente;' + document.getElementById('statDI').textContent + '\n';
    csvContent += 'BT p√©riode;' + document.getElementById('statBT').textContent + '\n';
    csvContent += 'R√©solus;' + document.getElementById('statResolved').textContent + '\n';
    csvContent += 'MTTR;' + document.getElementById('kpiMTTR').textContent + '\n';
    csvContent += 'Taux pannes;' + document.getElementById('kpiTauxPanne').textContent + '\n';
    
    // T√©l√©charger
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'GMAO_BAHIA_Rapport_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
    toast('‚úÖ Export t√©l√©charg√©');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.3 - FILTRES HISTORIQUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function populateHistoriqueFilters() {
    // Remplir liste op√©rateurs
    const operateurs = [...new Set(allDI.map(di => di.Operateur).filter(Boolean))];
    document.getElementById('histDIUser').innerHTML = '<option value="">Tous les op√©rateurs</option>' + 
        operateurs.map(op => `<option value="${op}">${op}</option>`).join('');
    
    // Remplir liste techniciens
    const techniciens = [...new Set(allBT.map(bt => bt.Technicien).filter(Boolean))];
    document.getElementById('histBTUser').innerHTML = '<option value="">Tous les techniciens</option>' + 
        techniciens.map(t => `<option value="${t}">${t}</option>`).join('');
    
    // Remplir liste machines
    const machines = [...new Set(allBT.map(bt => bt.Machine).filter(Boolean))];
    document.getElementById('histBTMachine').innerHTML = '<option value="">Toutes machines</option>' + 
        machines.map(m => `<option value="${m}">${m}</option>`).join('');
}

function renderHistoriqueDI() {
    let dis = [...allDI];
    
    // Filtre recherche
    const search = document.getElementById('searchHistDI').value.toLowerCase();
    if (search) {
        dis = dis.filter(di => 
            (di.ID||'').toLowerCase().includes(search) || 
            (di.Machine||'').toLowerCase().includes(search) || 
            (di.Anomalie||'').toLowerCase().includes(search) ||
            (di.Operateur||'').toLowerCase().includes(search)
        );
    }
    
    // Filtre utilisateur
    const userFilter = document.getElementById('histDIUser').value;
    if (userFilter) dis = dis.filter(di => di.Operateur === userFilter);
    
    // Filtre statut
    const statusFilter = document.getElementById('histDIStatus').value;
    if (statusFilter) dis = dis.filter(di => di.Statut === statusFilter);
    
    // Filtre dates
    const dateFrom = document.getElementById('histDIDateFrom').value;
    const dateTo = document.getElementById('histDIDateTo').value;
    if (dateFrom || dateTo) {
        dis = dis.filter(di => {
            if (!di.Date) return false;
            try {
                const parts = di.Date.split('/');
                const diDate = new Date(parts[2], parts[1]-1, parts[0]);
                if (dateFrom && diDate < new Date(dateFrom)) return false;
                if (dateTo && diDate > new Date(dateTo + 'T23:59:59')) return false;
                return true;
            } catch(e) { return false; }
        });
    }
    
    if (!dis.length) {
        document.getElementById('histDIList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucune DI trouv√©e</div></div>';
        return;
    }
    
    document.getElementById('histDIList').innerHTML = dis.map(di => `
        <div class="di-card ${di.Statut==='Cl√¥tur√©'?'done':''}">
            <div class="di-header">
                <div><div class="di-id">${di.ID}</div><div class="di-date">${di.Date||''}</div></div>
                <span class="di-badge ${di.Statut==='En attente'?'waiting':'done'}">${di.Statut}</span>
            </div>
            <div class="di-machine">‚öôÔ∏è ${di.Machine}</div>
            <div class="di-info">üìç ${di.Ligne} | üîß ${di.Zone}</div>
            <div class="di-info">üî© ${di.Composant} | ‚ö†Ô∏è ${di.Anomalie}</div>
            <div class="di-info">üë§ ${di.Operateur}</div>
            ${di.Photo ? '<div class="di-info">üì∑ Photo jointe</div>' : ''}
            ${di.BT_ID?`<div class="di-info" style="color:var(--secondary)">‚Üí ${di.BT_ID}</div>`:''}
        </div>
    `).join('');
}

function renderHistoriqueBT() {
    let bts = [...allBT];
    
    // Filtre recherche
    const search = document.getElementById('searchHistBT').value.toLowerCase();
    if (search) {
        bts = bts.filter(bt => 
            (bt.BT_ID||'').toLowerCase().includes(search) || 
            (bt.Anomalie_ID||'').toLowerCase().includes(search) || 
            (bt.Machine||'').toLowerCase().includes(search) ||
            (bt.Technicien||'').toLowerCase().includes(search)
        );
    }
    
    // Filtre technicien
    const userFilter = document.getElementById('histBTUser').value;
    if (userFilter) bts = bts.filter(bt => bt.Technicien === userFilter);
    
    // Filtre machine
    const machineFilter = document.getElementById('histBTMachine').value;
    if (machineFilter) bts = bts.filter(bt => bt.Machine === machineFilter);
    
    // Filtre dates
    const dateFrom = document.getElementById('histBTDateFrom').value;
    const dateTo = document.getElementById('histBTDateTo').value;
    if (dateFrom || dateTo) {
        bts = bts.filter(bt => {
            if (!bt.Date) return false;
            try {
                const parts = bt.Date.split('/');
                const btDate = new Date(parts[2], parts[1]-1, parts[0]);
                if (dateFrom && btDate < new Date(dateFrom)) return false;
                if (dateTo && btDate > new Date(dateTo + 'T23:59:59')) return false;
                return true;
            } catch(e) { return false; }
        });
    }
    
    if (!bts.length) {
        document.getElementById('histBTList').innerHTML = '<div class="list-empty"><div class="empty-icon">üì≠</div><div>Aucun BT trouv√©</div></div>';
        return;
    }
    
    document.getElementById('histBTList').innerHTML = bts.map(bt => `
        <div class="bt-card" onclick="openBTDetail('${bt.BT_ID}')">
            <div class="bt-header">
                <div><div class="bt-id">${bt.BT_ID}</div><div class="bt-ref">R√©f: ${bt.Anomalie_ID||'-'}</div></div>
                <span style="font-size:13px">${bt.Date||''}</span>
            </div>
            <div class="bt-grid">
                <div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${bt.Machine||'-'}</div></div>
                <div class="bt-section"><div class="bt-section-title">Technicien</div><div class="bt-section-value">${bt.Technicien||'-'}</div></div>
            </div>
            <div class="bt-grid">
                <div class="bt-section"><div class="bt-section-title">Cause</div><div class="bt-section-value">${bt.Cause||'-'}</div></div>
                <div class="bt-section"><div class="bt-section-title">Dur√©e</div><div class="bt-section-value">${bt.Duree||'-'} min</div></div>
            </div>
        </div>
    `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v8.3 - GESTION STATUTS BT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openChangeStatut(btId) {
    currentBT = allBT.find(b => b.BT_ID === btId);
    if (!currentBT) return;
    
    const statut = currentBT.Statut_BT || 'En cours';
    
    // V√©rifier droits de validation
    const canValidate = user.role === 'admin';
    
    // Info BT
    document.getElementById('modalStatutBTInfo').innerHTML = `
        <div class="bt-header">
            <div><div class="bt-id">${currentBT.BT_ID}</div><div class="bt-ref">R√©f: ${currentBT.Anomalie_ID||'-'}</div></div>
            <span class="bt-statut ${getStatutClass(statut)}">${getStatutIcon(statut)} ${statut}</span>
        </div>
        <div class="bt-section"><div class="bt-section-title">Machine</div><div class="bt-section-value">${currentBT.Machine||'-'}</div></div>
    `;
    
    // Mettre √† jour les options du select selon le statut actuel et les droits
    const selectStatut = document.getElementById('selectNewStatut');
    selectStatut.innerHTML = '';
    
    const statuts = [
        { value: 'En cours', label: 'üîß En cours', order: 1 },
        { value: 'En attente pi√®ces', label: 'üì¶ En attente pi√®ces', order: 2 },
        { value: 'Termin√©', label: '‚úÖ Termin√©', order: 3 },
        { value: 'Valid√©', label: '‚úîÔ∏è Valid√© (Admin)', order: 4, adminOnly: true }
    ];
    
    statuts.forEach(s => {
        // Admin peut choisir n'importe quel statut
        // Technicien ne peut pas choisir "Valid√©"
        if (!s.adminOnly || canValidate) {
            const option = document.createElement('option');
            option.value = s.value;
            option.textContent = s.label;
            if (s.value === statut) option.selected = true;
            selectStatut.appendChild(option);
        }
    });
    
    // Highlight current statut in workflow
    document.querySelectorAll('#modalStatutBT .statut-step').forEach(step => {
        step.classList.remove('active', 'completed');
        const stepStatut = step.dataset.statut;
        const stepOrder = statuts.find(s => s.value === stepStatut)?.order || 0;
        const currentOrder = statuts.find(s => s.value === statut)?.order || 0;
        
        if (stepStatut === statut) {
            step.classList.add('active');
        } else if (stepOrder < currentOrder) {
            step.classList.add('completed');
        }
    });
    
    document.getElementById('statutComment').value = '';
    openModal('modalStatutBT');
}

async function saveNewStatut() {
    if (!currentBT) return;
    
    const newStatut = document.getElementById('selectNewStatut').value;
    const comment = document.getElementById('statutComment').value.trim();
    const oldStatut = currentBT.Statut_BT || 'En cours';
    
    if (newStatut === oldStatut) {
        toast('‚ö†Ô∏è M√™me statut s√©lectionn√©');
        return;
    }
    
    // V√©rifier si admin pour valider
    if (newStatut === 'Valid√©' && user.role !== 'admin') {
        toast('‚ùå Seul un admin peut valider');
        return;
    }
    
    const btn = document.getElementById('btnSaveStatut');
    btn.disabled = true;
    btn.textContent = '‚è≥ Enregistrement...';
    
    const result = await apiCall('updateBTStatut', {
        btId: currentBT.BT_ID,
        newStatut: newStatut,
        comment: comment,
        userName: user.nom
    });
    
    if (result.success) {
        toast('‚úÖ Statut mis √† jour');
        closeModal('modalStatutBT');
        await loadAllData();
    } else {
        toast('‚ùå ' + (result.error || 'Erreur'));
    }
    
    btn.disabled = false;
    btn.textContent = 'üíæ Valider le changement';
}

// Event listener pour bouton save statut
document.getElementById('btnSaveStatut').addEventListener('click', saveNewStatut);
</script>
</body>
</html>
